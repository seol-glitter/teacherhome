<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>교사용 대시보드</title>
<meta name="robots" content="noindex,nofollow">
<style>
  :root{--primary:#0ea5e9; --line:#e2e8f0; --muted:#64748b}
  html,body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;color:#0f172a;background:#f8fafc}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .top{display:flex;align-items:center;gap:8px}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;background:#e2e8f0}
  .badge.alt{background:#bfdbfe}
  .badge.gray{background:#e5e7eb}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:16px;margin-top:12px}
  .note{color:var(--muted); font-size:12px; margin-top:6px}
  .pcBox{display:flex;align-items:center;gap:10px}
  .pcTag{font-weight:900;font-size:24px;letter-spacing:.2em}
  .pcBtn{padding:8px 12px;border:0;border-radius:10px;background:#0ea5e9;color:#fff;font-weight:800;cursor:pointer}
</style>

<body>
<!-- EXEC Glue (원본 동일) -->
<script>
(function () {
  const q = new URLSearchParams(location.search);
  const paramExec = (q.get('exec')||'').trim();
  const savedExec = localStorage.getItem('EXEC')||'';
  const DEFAULT_EXEC = "";
  const EXEC = paramExec || savedExec || DEFAULT_EXEC;
  if (EXEC && EXEC !== savedExec) localStorage.setItem('EXEC', EXEC);
  window.EXEC = EXEC;

  document.addEventListener('DOMContentLoaded', () => {
    if (!EXEC) return;
    document.querySelectorAll('a[href$=".html"]').forEach(a => {
      const u = new URL(a.getAttribute('href'), location.href);
      if (!u.searchParams.get('exec')) { u.searchParams.set('exec', EXEC); a.href = u.pathname + u.search; }
    });
  });
})();
</script>

<div class="wrap">
  <div class="top">
    <h1>교사용 대시보드</h1>
    <span id="bindPill" class="badge gray">손님</span>
    <a href="./index.html" class="badge alt" style="text-decoration:none">← 교사용 홈</a>
  </div>

  <!-- ☆ 추가: 학부모 공용코드(4자리) 자동 생성/표시 카드 ☆ -->
  <div class="card" id="pcCard" style="display:none">
    <h3>학부모 공용코드</h3>
    <div class="pcBox">
      <div id="pcTag" class="pcTag">----</div>
      <button id="btnCopy" class="pcBtn" type="button">복사</button>
    </div>
    <div class="note">이 코드는 자동 생성되며 바뀌지 않습니다. 학부모 열람: <b>기관명 / 학급명 / 코드(4자리) / 자녀번호(2자리)</b></div>
  </div>

  <!-- (이하: 원래의 표/툴바/최근업로드/모달 + 기존 JS 로직을 그대로 사용) -->
</div>

<!-- (원본 로직) -->
<script src="./js/dashboard.core.js"></script>

<script>
/* 최소 JS: tk로 ensureParentCode 호출 → 코드 표시 */
(function(){
  const EXEC=window.EXEC||''; const tk=(localStorage.getItem('tk')||localStorage.getItem('teacherKey')||'').trim();
  const pcCard=document.getElementById('pcCard'), pcTag=document.getElementById('pcTag'), btnCopy=document.getElementById('btnCopy');
  const pill=document.getElementById('bindPill');

  function jsonp(url,timeout=15000){
    return new Promise((res,rej)=>{
      const cb='cb_'+Math.random().toString(36).slice(2); let done=false;
      const t=setTimeout(()=>{if(done)return;done=true;cleanup();rej(new Error('timeout'));},timeout);
      function cleanup(){try{delete window[cb];s.remove();}catch(_){ } clearTimeout(t);}
      window[cb]=d=>{if(done)return;done=true;cleanup();res(d);};
      const s=document.createElement('script'); s.src=url+(url.includes('?')?'&':'?')+'callback='+cb; s.onerror=()=>{if(done)return;done=true;cleanup();rej(new Error('network'));};
      document.body.appendChild(s);
    });
  }

  async function init(){
    if(tk){ pill.textContent='연결됨'; pill.classList.remove('gray'); }
    if(!EXEC || !tk) return;
    try{
      const j=await jsonp(EXEC+'?'+new URLSearchParams({action:'ensureParentCode',key:tk}));
      if(j && j.ok && j.parentCode){
        pcTag.textContent=String(j.parentCode).padStart(4,'0');
        pcCard.style.display='block';
        // 기존 입력칸이 있으면 읽기전용/회색 처리(최소 변경)
        const input = document.querySelector('#parentCode, input[name="parentCode"]');
        if(input){
          input.value = j.parentCode;
          input.readOnly = true;
          input.style.background = '#f1f5f9';
          const note = document.createElement('div'); note.className='note';
          note.textContent='※ 학부모용 코드는 자동 부여되며 변경되지 않습니다. 위 코드를 학부모에게 안내하세요.';
          input.insertAdjacentElement('afterend', note);
        }
      }
    }catch(_){}
  }

  btnCopy.onclick = ()=>{ navigator.clipboard.writeText(pcTag.textContent||''); btnCopy.textContent='복사됨'; setTimeout(()=>btnCopy.textContent='복사',1200); };
  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
