<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>대시보드</title>
<!-- 기존 스타일/레이아웃은 그대로 두셨다고 가정 -->
<body>
<script>
// EXEC Glue (간결 버전)
(function(){
  const q=new URLSearchParams(location.search);
  const e=q.get('exec')||localStorage.getItem('EXEC')||'';
  if(e) localStorage.setItem('EXEC',e);
  window.EXEC=e;
})();
</script>

<div id="root"><!-- 기존 UI 그대로 --></div>

<script>
const qs=new URLSearchParams(location.search);
const mode=(qs.get('mode')||localStorage.getItem('mode')||'b').toLowerCase()==='a'?'a':'b';
const EXEC_A='REPLACE_WITH_NEW_EXEC_A', EXEC_B='REPLACE_WITH_NEW_EXEC_B';
const EXEC=window.EXEC || ((mode==='a')?EXEC_A:EXEC_B);
let tk = (qs.get('tk')||localStorage.getItem('tk')||localStorage.getItem('teacherKey')||'').trim();
if(qs.get('tk')){ localStorage.setItem('tk',tk); localStorage.setItem('teacherKey',tk); }
localStorage.setItem('mode',mode);

const $id=(s)=>document.getElementById(s);
const LS_LAST_CHILD_KEY = (tk?('lastChild_'+tk):'lastChild');
const LS_PARENT_CODE_KEY = (tk?('parentCode_'+tk):'parentCode');

function jsonp(url, timeout=15000){
  return new Promise((res,rej)=>{
    const cb='cb_'+Math.random().toString(36).slice(2); let done=false;
    const t=setTimeout(()=>{ if(done)return; done=true; cleanup(); rej(new Error('timeout')); }, timeout);
    function cleanup(){ try{ delete window[cb]; s.remove(); }catch(_){ } clearTimeout(t); }
    window[cb]=d=>{ if(done)return; done=true; cleanup(); res(d); };
    const s=document.createElement('script');
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb; s.onerror=()=>{ if(done)return; done=true; cleanup(); rej(new Error('network')); };
    document.body.appendChild(s);
  });
}

/* ===== 초기: TK 메타 불러오기 + 학부모코드 입력칸 채우기 ===== */
let roster=[];
async function init(){
  if(!EXEC||!tk){ alert('EXEC/tk 누락'); return; }
  const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'resolveKey', key: tk}));
  roster = (r && Array.isArray(r.roster)) ? r.roster : [];
  // 부모코드 자동 세팅
  const pc = (r && r.parentCode) ? r.parentCode : (localStorage.getItem(LS_PARENT_CODE_KEY)||'');
  const inp = document.querySelector('input[name="parentCode"], #parentCode');
  if(inp){ inp.value = pc || ''; }
  if(pc){ localStorage.setItem(LS_PARENT_CODE_KEY, pc); }
}
init().catch(()=>{});

/* ===== 학부모 코드 저장 시 로컬에도 저장 ===== */
async function saveParentCode(pc){
  if(!pc){ alert('학부모코드를 입력하세요'); return; }
  const res = await jsonp(EXEC+'?'+new URLSearchParams({action:'setParentCode', key:tk, parentCode:pc}));
  if(res && res.ok){ localStorage.setItem(LS_PARENT_CODE_KEY, pc); alert('저장되었습니다'); }
  else { alert('저장 실패: '+(res&&res.error||'error')); }
}
// 만약 기존 버튼/입력이 있다면, 그 핸들러 내부 마지막에 다음 한 줄만 추가하면 됩니다:
// localStorage.setItem(LS_PARENT_CODE_KEY, 입력값);

/* ===== 최근 목록/성취표 로딩(기존 호출 유지) ===== */
// ... 기존의 listByChild/thumbB64 렌더 로직 그대로 사용 ...

/* ===== 재분류(이름 지정) 시 마지막 아이 기억 ===== */
async function reassign(fileId, newChild, newProblem){
  const res = await jsonp(EXEC+'?'+new URLSearchParams({action:'reassignRecord', key:tk, fileId:fileId, child:newChild, problem:newProblem}));
  if(res && res.ok){
    if(newChild){ localStorage.setItem(LS_LAST_CHILD_KEY, newChild); } // ✅ 기억
    // 이어서 기존 UI 갱신 호출
    // refresh();
  }else{
    alert('재분류 실패: '+(res&&res.error||'error'));
  }
}
// ↑ 기존 재분류 버튼 로직에서 서버 호출 부분만 위 함수로 바꾸거나,
// 호출 직후 `if (child) localStorage.setItem(LS_LAST_CHILD_KEY, child);` 한 줄만 덧붙여도 동일 효과.

</script>
</body>
</html>
