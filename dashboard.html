<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>교사용 대시보드</title>
<meta name="robots" content="noindex,nofollow" />
<style>
:root{
  --bg1:#dff0ff; --bg2:#eaf6ff; --ink:#0f172a; --muted:#475569;
  --card:#ffffff; --line:#e2e8f0; --brand:#0ea5e9; --brandD:#0284c7;
  --ok:#16a34a; --warn:#f97316; --danger:#ef4444;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0; color:var(--ink);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
}
.wrap{max-width:1180px;margin:0 auto;padding:18px}
.top{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px}
h1{margin:0;font-size:clamp(22px,4.8vw,32px)}
.badge{padding:6px 10px;border-radius:999px;background:#0f172a;color:#fff;font-weight:900;font-size:12px}
.badge.alt{background:#10b981}
.badge.gray{background:#94a3b8}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 2px 8px rgba(15,23,42,.06)}
h3{margin:0 0 10px 0;font-size:18px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.input{padding:10px 12px;border:1px solid var(--line);border-radius:10px;min-width:160px}
.input:focus{outline:2px solid var(--brand)}
.btn{padding:10px 14px;border:0;border-radius:10px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
.btn:active{transform:translateY(1px)} .btn.alt{background:var(--brandD)}
.btn.gray{background:#64748b}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:10px;text-align:left;font-size:14px}
.table tr:hover{background:#f8fafc}
.kv{display:grid;grid-template-columns:110px 1fr;gap:8px;align-items:center}
.small{font-size:12px;color:var(--muted)}
.note{font-size:12px;color:var(--muted);margin-top:6px}
.code{font-family:ui-monospace,Consolas,Menlo,monospace;background:#0f172a;color:#fff;border-radius:8px;padding:8px 10px}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center}
.modal .box{background:#fff;width:min(780px,96vw);border-radius:16px;padding:16px}
.modal .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.modal .hdr h4{margin:0}
.modal .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
img.thumb{display:block;max-width:100%;height:auto;border-radius:10px;border:1px solid var(--line)}
</style>

<body>
<div class="wrap">
  <div class="top">
    <h1>교사용 대시보드</h1>
    <span id="badgeMode" class="badge gray">MODE</span>
    <span id="badgeTk" class="badge">teacherKey</span>
  </div>

  <!-- A0: 로그인 상태 -->
  <section class="card">
    <div class="kv">
      <div>상태</div><div id="statusText" class="small">확인 중…</div>
      <div>기관/반</div><div><span id="schoolId" class="code">-</span> / <span id="classId" class="code">-</span></div>
    </div>
  </section>

  <!-- A1: 유아 명단 -->
  <section class="card">
    <h3>유아 명단</h3>
    <div class="row">
      <textarea id="taRoster" class="input" style="min-width:320px;min-height:90px" placeholder="김가람, 박서율, …"></textarea>
      <button id="btnRosterSave" class="btn">저장</button>
    </div>
    <div class="note">쉼표(,) 또는 줄바꿈으로 구분하여 입력합니다. (예: 김가람, 박서율, …)</div>
  </section>

  <!-- A2: 학부모 공용코드 -->
  <section class="card" id="cardParent">
    <h3>학부모 공용코드</h3>
    <div class="row">
      <input id="inputParentCode" class="input" style="flex:1 1 260px" placeholder="예: FIRE12" />
      <button id="btnParentSave" class="btn">저장</button>
    </div>
    <div class="note">학부모에게 이 코드를 안내하면 자녀 성취를 열람할 수 있습니다.</div>
  </section>

  <!-- A3: 교사용 비밀번호 변경 -->
  <section class="card" id="cardPw">
    <h3>교사용 비밀번호 변경</h3>
    <div class="row">
      <input id="oldCode" class="input" placeholder="현재 비밀번호" />
      <input id="newCode" class="input" placeholder="새 비밀번호" />
      <button id="btnChangePw" class="btn alt">변경</button>
    </div>
  </section>

  <!-- A4: 기록/초기화 -->
  <section class="card">
    <h3>기록 초기화</h3>
    <div class="row">
      <button id="btnPurge" class="btn danger" style="background:var(--danger)">촬영기록·명단 초기화</button>
      <button id="btnUnlink" class="btn gray">이 기기 연결 해제</button>
    </div>
    <div class="note">※ 학급과 교사 비밀번호는 유지됩니다. (완전삭제는 서버 콘솔에서만 가능)</div>
  </section>

  <!-- B: 성취 요약 -->
  <section class="card">
    <h3>유아별 최신 성취</h3>
    <table class="table" id="tblPerf">
      <thead><tr><th>유아</th><th>문항</th><th>시간</th><th>미리보기</th><th>관리</th></tr></thead>
      <tbody id="tbodyPerf"></tbody>
    </table>
  </section>

  <!-- C: 최근 업로드 -->
  <section class="card">
    <h3>최근 업로드 (최신 100개)</h3>
    <table class="table" id="tblRecent">
      <thead><tr><th>시간</th><th>유아</th><th>문항</th><th>미리보기</th><th>관리</th></tr></thead>
      <tbody id="tbodyRecent"></tbody>
    </table>
  </section>
</div>

<!-- 미리보기/관리 모달 -->
<div id="modal" class="modal">
  <div class="box">
    <div class="hdr">
      <h4>기록 관리</h4>
      <button id="btnCloseModal" class="btn gray">닫기</button>
    </div>
    <div class="grid">
      <div>
        <img id="imgPreview" class="thumb" src="" alt="preview" />
      </div>
      <div>
        <div class="row" style="margin-bottom:8px">
          <input id="editChild" class="input" placeholder="유아 이름(빈칸 허용)" />
          <input id="editProb" class="input" placeholder="문항 코드(예: P1)" />
        </div>
        <div class="row">
          <button id="btnSaveEdit" class="btn">변경 저장</button>
          <button id="btnDelete" class="btn danger" style="background:var(--danger)">삭제</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ★ 여기에 "새 배포 URL"을 넣으세요
const EXEC_A = "https://script.google.com/macros/s/AKfycby4camh7...nlV4ElL3eJPUUWvslSAtfyssAQBRfizcY9D1MRJK9r_O0ZYDnQvKryalG/exec";
const EXEC_B = "https://script.google.com/macros/s/AKfycbzNUWjOh...V-Cu2WYkl6voDKoAHFKjOl_OQbKH6rQYj6o8K06YoQmc0D7Q6WMJJ-Foz/exec";

const qs = new URLSearchParams(location.search);
const mode = (qs.get('mode') || localStorage.getItem('mode') || 'b').toLowerCase()==='a' ? 'a' : 'b';
localStorage.setItem('mode', mode);
const EXEC = (mode==='a')? EXEC_A : EXEC_B;

let tk = (localStorage.getItem('tk') || localStorage.getItem('teacherKey') || '').trim();
let schoolId='', classId='', roster=[];

// 문항 코드(대시보드 고정 7개)
const PROBLEMS = [
  {id:'P1', title:'화재 원인'},
  {id:'P2', title:'대피 수칙'},
  {id:'P3', title:'피난유도등'},
  {id:'P4', title:'옷에 불 대처'},
  {id:'P5', title:'119 신고'},
  {id:'P6', title:'투척 소화기'},
  {id:'P7', title:'추가 문항'}
];

function setHeader(){
  document.getElementById('badgeMode').textContent = 'MODE '+mode.toUpperCase();
  document.getElementById('badgeTk').textContent = (tk? tk.slice(0,10)+'…' : 'Guest');
  const s = document.getElementById('statusText');
  s.textContent = tk? '연결됨' : '손님 모드';
}
setHeader();

async function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = 'cb_'+Math.random().toString(36).slice(2);
    const u = url + (url.includes('?')?'&':'?') + 'callback='+cb;
    const s = document.createElement('script');
    window[cb] = (data)=>{ resolve(data); try{ delete window[cb]; }catch(_){ } s.remove(); };
    s.onerror = ()=>{ reject(new Error('net')); try{ delete window[cb]; }catch(_){ } s.remove(); };
    s.src = u; document.body.appendChild(s);
  });
}

function fmt(ts){
  const d = new Date(Number(ts||0)); if(!isFinite(d)) return '-';
  const Y=d.getFullYear(), M=String(d.getMonth()+1).padStart(2,'0'), D=String(d.getDate()).padStart(2,'0');
  const h=String(d.getHours()).padStart(2,'0'), m=String(d.getMinutes()).padStart(2,'0');
  return `${Y}-${M}-${D} ${h}:${m}`;
}

// ===== 성취/최근 목록 로드 =====
async function loadPerformance(){
  if(!tk) return;
  const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'listByChild', key:tk}));
  const tbody = document.getElementById('tbodyPerf'); tbody.innerHTML='';
  if(!r || !r.ok){ tbody.innerHTML = '<tr><td colspan="5">불러오기 실패</td></tr>'; return; }
  const items = r.items || [];
  const byChild = {};
  for(const it of items){
    if(!byChild[it.child]) byChild[it.child] = [];
    byChild[it.child].push(it);
  }
  for(const ch of Object.keys(byChild).sort()){
    for(const it of byChild[ch]){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${ch||'-'}</td><td>${it.problem}</td><td>${fmt(it.ts)}</td>
        <td><button class="btn gray" data-fid="${it.fileId}" data-mime="${it.mime}">보기</button></td>
        <td><button class="btn alt" data-fid="${it.fileId}" data-ch="${ch}" data-pr="${it.problem}">관리</button></td>`;
      tbody.appendChild(tr);
    }
  }
}

async function loadRecent(){
  if(!tk) return;
  const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'listRecent', key:tk, limit:100}));
  const tbody = document.getElementById('tbodyRecent'); tbody.innerHTML='';
  if(!r || !r.ok){ tbody.innerHTML = '<tr><td colspan="5">불러오기 실패</td></tr>'; return; }
  for(const it of (r.items||[])){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${fmt(it.ts)}</td><td>${it.child||'-'}</td><td>${it.problem}</td>
      <td><button class="btn gray" data-fid="${it.fileId}" data-mime="${it.mime}">보기</button></td>
      <td><button class="btn alt" data-fid="${it.fileId}" data-ch="${it.child||''}" data-pr="${it.problem}">관리</button></td>`;
    tbody.appendChild(tr);
  }
}

document.addEventListener('click', async (ev)=>{
  const b = ev.target.closest('button'); if(!b) return;
  if(b.matches('#tbodyPerf .btn.gray, #tbodyRecent .btn.gray')){
    const fid=b.dataset.fid, mime=b.dataset.mime;
    const r=await jsonp(EXEC+'?'+new URLSearchParams({action:'thumbB64', fileId:fid}));
    if(r && r.ok){ imgPreview.src = `data:${r.mime};base64,${r.b64}`; modal.style.display='flex'; }
    else alert('미리보기 실패');
  }
  if(b.matches('#tbodyPerf .btn.alt, #tbodyRecent .btn.alt')){
    editingFid = b.dataset.fid||'';
    editChild.value = b.dataset.ch||'';
    editProb.value = b.dataset.pr||'';
    const r=await jsonp(EXEC+'?'+new URLSearchParams({action:'thumbB64', fileId:editingFid}));
    if(r && r.ok){ imgPreview.src = `data:${r.mime};base64,${r.b64}`; modal.style.display='flex'; }
    else alert('미리보기 실패');
  }
});

let editingFid='';
const modal = document.getElementById('modal');
const imgPreview = document.getElementById('imgPreview');
const editChild = document.getElementById('editChild');
const editProb = document.getElementById('editProb');
document.getElementById('btnCloseModal').onclick = ()=>{ modal.style.display='none'; };

document.getElementById('btnSaveEdit').onclick = async ()=>{
  if(!tk || !editingFid){ alert('대상을 찾을 수 없습니다.'); return; }
  try{
    const r = await jsonp(EXEC+'?'+new URLSearchParams({
      action:'reassignRecord', key:tk, fileId:editingFid, child:editChild.value||'', problem:(editProb.value||'').trim()
    }));
    if(r && r.ok){
      modal.style.display='none';
      await loadPerformance();
      await loadRecent();
      alert('저장되었습니다.');
    }else{
      alert('저장 실패: '+(r&&r.error?r.error:'서버'));
    }
  }catch(_){ alert('네트워크 오류'); }
};

document.getElementById('btnDelete').onclick = async ()=>{
  if(!tk || !editingFid){ alert('대상을 찾을 수 없습니다.'); return; }
  if(!confirm('이 기록을 삭제할까요?')) return;
  try{
    const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'deleteRecord', key:tk, fileId: editingFid}));
    if(r && r.ok){
      modal.style.display='none';
      await loadPerformance();
      await loadRecent();
      alert('삭제되었습니다.');
    }else{
      alert('삭제 실패: '+(r&&r.error?r.error:'서버'));
    }
  }catch(_){ alert('네트워크 오류'); }
};

// ===== 명단/공용코드/비번/초기화/연결해제 =====

// (1) 유아 명단 저장
document.getElementById('btnRosterSave').onclick = async ()=>{
  if(!tk){ alert('먼저 로그인하세요.'); return; }
  const raw = document.getElementById('taRoster').value || '';
  try{
    const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'saveRoster', key:tk, roster: raw}));
    if(r && r.ok){ alert('저장되었습니다.'); }
    else alert('저장 실패: '+(r&&r.error?r.error:'서버'));
  }catch(_){ alert('네트워크 오류'); }
};

// (2) 학부모 공용코드 저장 (에러별 안내 강화)
document.getElementById('btnParentSave').onclick = async ()=>{
  if(!tk){ alert('먼저 로그인하세요.'); return; }
  const pc = (document.getElementById('inputParentCode').value || '').trim();
  if(!pc){ alert('학부모 공용코드를 입력하세요.'); return; }

  try{
    const p = new URLSearchParams({action:'setParentCode', key:tk, parentCode: pc});
    let r = await jsonp(EXEC+'?'+p);
    if(r && r.error && /unknown action/i.test(r.error)){
      const ALT = (EXEC===EXEC_A) ? EXEC_B : EXEC_A;
      r = await jsonp(ALT+'?'+p);
    }

    if(r && r.ok){
      alert('저장되었습니다.');
    }else{
      const err = (r && r.error) || 'server';
      if(err === 'missing'){
        alert('저장 실패: 값 누락\n→ 공용코드를 다시 입력해 주세요.');
      }else if(err === 'no class'){
        alert('저장 실패: 학급 메타 정보가 없습니다.\n→ 홈(교사용 사이트)에서 기관/반/교사비번으로 먼저 연결하세요.');
      }else if(err === 'class not found'){
        alert('저장 실패: 학급 객체가 없습니다.\n→ 홈에서 다시 로그인(연결)하여 학급을 재생성하고,\n   대시보드의 모드(A/B)가 로그인했던 모드와 같은지 확인하세요.');
      }else if(err === 'auth'){
        alert('저장 실패: 교사 비밀번호가 일치하지 않습니다.\n→ 홈에서 올바른 비밀번호로 다시 연결하세요.');
      }else if(/unknown action/i.test(err)){
        alert('저장 실패: 서버 배포 URL 불일치\n→ 상단 모드(A/B)와 배포 URL을 확인하세요.');
      }else{
        alert('저장 실패: '+ err);
      }
      console.info('[DEBUG:setParentCode]', { mode:(typeof mode!=='undefined'?mode:undefined), EXEC, tk, pc, resp:r });
    }
  }catch(_){
    alert('네트워크 오류');
  }
};

// (3) 교사 비밀번호 변경
document.getElementById('btnChangePw').onclick = async ()=>{
  if(!tk){ alert('먼저 로그인하세요.'); return; }
  const oldC = (document.getElementById('oldCode').value || '').trim();
  const newC = (document.getElementById('newCode').value || '').trim();
  if(!oldC || !newC){ alert('현재/새 비밀번호를 입력하세요.'); return; }
  try{
    const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'changeTeacherCode', key:tk, old:oldC, new:newC}));
    if(r && r.ok){ alert('변경되었습니다. 다음 접속부터 새 비밀번호를 사용하세요.'); }
    else alert('변경 실패: '+(r&&r.error?r.error:'서버'));
  }catch(_){ alert('네트워크 오류'); }
};

// (4) 기록 초기화
document.getElementById('btnPurge').onclick = async ()=>{
  if(!tk){ alert('먼저 로그인하세요.'); return; }
  if(!confirm('이 학급의 촬영 기록과 유아 명단을 삭제합니다. (학급/비번은 유지)\n진행할까요?')) return;
  try{
    const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'purgeData', key:tk}));
    if(r && r.ok){ alert('기록이 삭제되었습니다.'); await loadPerformance(); await loadRecent(); }
    else alert('실패: '+(r&&r.error?r.error:'서버'));
  }catch(_){ alert('네트워크 오류'); }
};

// (5) 연결 해제
document.getElementById('btnUnlink').onclick = ()=>{
  if(!confirm('이 기기의 연결 정보를 삭제하고 손님모드로 전환합니다. 진행할까요?')) return;
  try{
    localStorage.removeItem('tk');
    localStorage.removeItem('teacherKey');
    Object.keys(localStorage).forEach(k=>{ if(k.startsWith('faceDB::')) localStorage.removeItem(k); });
  }catch(_){}
  tk=''; setHeader(); alert('이 기기에서 연결이 해제되었습니다.');
};

// ===== 최초 진입 시 데이터 로드 =====
(async function init(){
  if(!tk){
    document.getElementById('statusText').textContent='손님 모드 (홈에서 먼저 연결하세요)';
    return;
  }
  setHeader();
  const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'resolveKey', key:tk}));
  if(r && r.ok){
    schoolId = r.schoolId||'';
    classId = r.classId||'';
    roster = r.roster||[];
    document.getElementById('schoolId').textContent = schoolId||'-';
    document.getElementById('classId').textContent = classId||'-';
    document.getElementById('taRoster').value = roster.join(', ');
    await loadPerformance();
    await loadRecent();
  }else{
    document.getElementById('statusText').textContent='학급 정보를 불러오지 못했습니다.';
  }
})();
</script>
</body>
</html>
