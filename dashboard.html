<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>교사용 대시보드</title>
<meta name="robots" content="noindex,nofollow">
<style>
  :root{--primary:#0ea5e9; --line:#e2e8f0; --muted:#64748b}
  html,body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;color:#0f172a;background:#f8fafc}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .top{display:flex;align-items:center;gap:8px}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;background:#e2e8f0}
  .badge.alt{background:#bfdbfe}
  .badge.gray{background:#e5e7eb}

  /* 유아 성취도 표(원본 스타일 유지) */
  .tableWrap{overflow:auto}
  table{width:100%; border-collapse:collapse; margin-top:6px}
  th,td{border-top:1px solid var(--line); padding:8px; text-align:center; font-size:14px}
  th:first-child,td:first-child{text-align:left}
  thead th{background:#f8fafc; position:sticky; top:0; z-index:1}

  /* 썸네일/업로드/모달 등 원본 클래스들 */
  .kid{cursor:pointer}
  .kid:hover{background:#f1f5f9}
  .thumb{width:72px; height:54px; object-fit:cover; border-radius:10px; background:#e2e8f0; display:block; margin:0 auto}
  .empty{color:#94a3b8}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap; margin-top:8px}
  .pill{padding:6px 10px; border-radius:999px; background:#e2e8f0; cursor:pointer; font-weight:700}
  .pill.on{background:#0ea5e9; color:#fff}

  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:10px}
  .thumbBox{border:1px solid var(--line); border-radius:12px; background:#fff; padding:6px; cursor:pointer}
  .thumbBox img{width:100%; height:86px; object-fit:cover; border-radius:8px; background:#e2e8f0}
  .thumbBox .cap{font-size:12px; margin-top:4px; color:#334155}

  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:99}
  .sheet{background:#fff;border-radius:12px;max-width:920px;width:92%;padding:14px;border:1px solid var(--line)}
  .sheet h4{margin:0 0 10px}
  .sheet .row{margin-top:8px}
  .sheet .imgBig{width:100%; height:240px; object-fit:contain; background:#000; border-radius:10px}
  .sheet .sel{height:40px; border:1px solid #cbd5e1; border-radius:10px; padding:0 10px; font-weight:800; width:100%}
  .sheet .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
</style>

<body>
<!-- EXEC Glue (원본 유지) -->
<script>
(function () {
  const q = new URLSearchParams(location.search);
  const paramExec = (q.get('exec')||'').trim();
  const savedExec = localStorage.getItem('EXEC')||'';
  const DEFAULT_EXEC = ""; // 필요시 고정
  const EXEC = paramExec || savedExec || DEFAULT_EXEC;
  if (EXEC && EXEC !== savedExec) localStorage.setItem('EXEC', EXEC);
  window.EXEC = EXEC;

  document.addEventListener('DOMContentLoaded', () => {
    if (!EXEC) return;
    document.querySelectorAll('a[href$=".html"]').forEach(a => {
      const u = new URL(a.getAttribute('href'), location.href);
      if (!u.searchParams.get('exec')) { u.searchParams.set('exec', EXEC); a.href = u.pathname + u.search; }
    });
  });
})();
</script>

<div class="wrap">
  <div class="top">
    <h1>교사용 대시보드</h1>
    <span id="bindPill" class="badge gray">손님</span>
    <a href="./index.html" class="badge alt" style="text-decoration:none">← 교사용 홈</a>
  </div>

  <!-- 이 아래 영역은 기존 dashboard.core.js가 DOM을 채웁니다. (변경 없음) -->
  <div id="dashboard-root"></div>
</div>

<!-- 원본 대시보드 로직(변경하지 마세요) -->
<script src="./js/dashboard.core.js"></script>

<!-- ✅ 최소추가: 부모코드 자동 보장 + 기존 입력칸에 값만 채움 -->
<script>
(function(){
  const EXEC = window.EXEC || '';
  const pill = document.getElementById('bindPill');

  // JSONP 헬퍼 (원본에 있더라도 충돌 없음: 지역함수)
  function jsonp(url, timeout=15000){
    return new Promise((res, rej)=>{
      const cb = 'cb_'+Math.random().toString(36).slice(2);
      let done = false;
      const t = setTimeout(()=>{ if(done) return; done=true; cleanup(); rej(new Error('timeout')); }, timeout);
      function cleanup(){ try{ delete window[cb]; s.remove(); }catch(_){ } clearTimeout(t); }
      window[cb] = d => { if(done) return; done=true; cleanup(); res(d); };
      const s = document.createElement('script');
      s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
      s.onerror = ()=>{ if(done) return; done=true; cleanup(); rej(new Error('network')); };
      document.body.appendChild(s);
    });
  }

  async function ensureParentCodeAndFill(){
    try{
      // TK는 기존 코드가 저장해 둔 키들 중 하나를 그대로 사용
      const tk = (localStorage.getItem('tk') || localStorage.getItem('teacherKey') || '').trim();
      if(tk){ pill.textContent='연결됨'; pill.classList.remove('gray'); }
      if(!EXEC || !tk) return;

      // 1) 숫자4자리 부모코드 보장
      const r = await jsonp(EXEC + '?' + new URLSearchParams({ action:'ensureParentCode', key:tk }));
      const pc = (r && r.ok && r.parentCode) ? String(r.parentCode) : '';

      // 2) 기존 입력칸에 값만 채움(아이디/네임 아무거나 대응)
      if(pc){
        const ip = document.querySelector('#parentCode, input[name="parentCode"]');
        if(ip){ ip.value = pc; }
      }
    }catch(e){ /* 조용히 실패 */ }
  }

  document.addEventListener('DOMContentLoaded', ensureParentCodeAndFill);
})();
</script>
</body>
</html>
