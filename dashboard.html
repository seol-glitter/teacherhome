<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>교사용 대시보드</title>
<meta name="robots" content="noindex,nofollow" />
<style>
:root{
  --bg1:#dff0ff; --bg2:#eaf6ff; --ink:#0f172a; --muted:#475569;
  --card:#ffffff; --line:#e2e8f0; --brand:#0ea5e9; --brandD:#0284c7;
  --ok:#16a34a; --warn:#f97316; --danger:#ef4444;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0; color:var(--ink);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
}
.wrap{max-width:1200px; margin:0 auto; padding:18px}
.top{display:flex; align-items:center; gap:10px; justify-content:space-between}
.badge{display:inline-block; padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px; background:#0f172a; color:#fff}
.badge.gray{background:#475569}
.badge.alt{background:#0ea5e9}
.card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; margin-top:14px}
.card h3{margin:0 0 10px}
.toolbar{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
.pill{padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:800}
.pill.on{background:#e0f2fe; border-color:#bae6fd}
.note{color:var(--muted); font-size:12px}
.tableWrap{overflow:auto; border:1px solid var(--line); border-radius:12px; margin-top:10px}
table{border-collapse:collapse; width:100%; background:#fff}
th,td{border-bottom:1px solid #e5e7eb; padding:8px 10px; text-align:center}
th:first-child, td:first-child{text-align:left}
tr:hover td{background:#f8fafc}
.thumbGrid{display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:10px; margin-top:10px}
.thumbBox{border:1px solid #e5e7eb; border-radius:10px; padding:8px; background:#fff}
.thumbBox img{width:100%; height:140px; object-fit:cover; border-radius:8px; background:#000; cursor:pointer}
.thumbBox .cap{font-size:12px; color:#334155; margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

/* 편집 모달 */
#modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(15,23,42,.4); backdrop-filter:saturate(1.1) blur(2px)}
#modal .sheet{background:#fff; border-radius:14px; width:min(96vw,520px); padding:16px}
#modal .sheet h4{margin:0 0 10px}
#modal .sheet .row{margin-top:8px}
#modal .sheet .imgBig{width:100%; height:240px; object-fit:contain; background:#000; border-radius:10px}
#modal .sheet .sel{height:40px; border:1px solid #cbd5e1; border-radius:10px; padding:0 10px; font-weight:800; width:100%}
#modal .sheet .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
.btn{padding:10px 14px; border:0; border-radius:12px; font-weight:900; color:#fff; background:#0ea5e9; cursor:pointer}
.btn:hover{background:#0284c7}
.btn.ok{background:#16a34a} .btn.ok:hover{background:#15803d}
.btn.danger{background:#ef4444} .btn.danger:hover{background:#dc2626}
.inp{height:40px; border:1px solid #cbd5e1; border-radius:10px; padding:0 10px; width:100%}
</style>

<body>
<div class="wrap">
  <div class="top">
    <h1>교사용 대시보드</h1>
    <span id="modePill" class="badge">모드 B</span>
    <span id="bindPill" class="badge gray">손님</span>
    <a href="./index.html" class="badge alt" style="text-decoration:none">← 교사용 홈</a>
  </div>

  <!-- A0: 유아 성취도 -->
  <section class="card" id="cardPerf">
    <h3>유아 성취도</h3>
    <div class="toolbar">
      <span class="pill on" id="btnAll">모두 보기</span>
      <span class="pill" id="btnOnlyUnassigned">미분류만</span>
      <span class="note" id="klassInfo"></span>
    </div>
    <div class="tableWrap">
      <table id="tbl">
        <thead>
          <tr>
            <th style="min-width:140px">유아명</th>
            <th>02 위험찾기</th>
            <th>03 화재대피 안전수칙</th>
            <th>04 비상구로 대피</th>
            <th>05 옷에 불이 붙었어요</th>
            <th>06 119 신고하기</th>
            <th>07 소화기 사용법</th>
            <th>08 완강기 사용법</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="noItems" class="note" style="padding:12px; display:none">데이터가 아직 없습니다.</div>
    </div>
  </section>

  <!-- A1: 최근 촬영 -->
  <section class="card" id="cardRecent">
    <h3>최근 촬영</h3>
    <div class="thumbGrid" id="recentGrid"></div>
  </section>

  <!-- A2: 명단 & 학부모 코드 -->
  <section class="card" id="cardConfig">
    <h3>설정</h3>
    <div class="toolbar" style="gap:10px">
      <div style="flex:1; min-width:260px">
        <div class="note" style="margin-bottom:6px">유아 명단 (줄바꿈 또는 쉼표 구분)</div>
        <textarea id="txtRoster" class="inp" style="height:120px; resize:vertical"></textarea>
        <div style="margin-top:8px; display:flex; gap:8px">
          <button id="btnRosterSave" class="btn">명단 저장</button>
        </div>
      </div>
      <div style="flex:1; min-width:240px">
        <div class="note" style="margin-bottom:6px">학부모 공용코드</div>
        <input id="inputParentCode" class="inp" placeholder="예) FLOWER-2025" />
        <div style="margin-top:8px; display:flex; gap:8px">
          <button id="btnParentSave" class="btn">공용코드 저장</button>
          <button id="btnUnlink" class="btn danger">이 기기 연결 해제</button>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- 편집 모달 -->
<div id="modal">
  <div class="sheet">
    <h4>사진 편집/분류</h4>
    <img id="big" class="imgBig" alt="">
    <div class="row">
      <select id="selChild" class="sel"></select>
    </div>
    <div class="row">
      <select id="selProb" class="sel"></select>
    </div>
    <div class="actions">
      <button id="btnDel" class="btn danger">삭제</button>
      <button id="btnSave" class="btn ok">저장</button>
      <button id="btnClose" class="btn">닫기</button>
    </div>
  </div>
</div>

<script>
/* ===== EXEC 설정 =====
 * 1) 심사용 A모드만 쓰면 EXEC_A만 채워도 됩니다.
 * 2) 모든 페이지는 index.html?exec=<교사용 EXEC> 로 최초 진입하세요. 그러면 window.EXEC에 보관됩니다.
 */
const EXEC_A = "REPLACE_WITH_EXEC_A"; // ← 한 줄로
const EXEC_B = "REPLACE_WITH_EXEC_B"; // ← 한 줄로

// Glue: ?exec= 를 우선 사용
(function(){
  const q=new URLSearchParams(location.search);
  const pExec = (q.get('exec')||'').trim();
  if(pExec) localStorage.setItem('EXEC', pExec);
  if(!window.EXEC) window.EXEC = pExec || localStorage.getItem('EXEC') || '';
})();

const qs = new URLSearchParams(location.search);
const mode = (qs.get('mode') || localStorage.getItem('mode') || 'b').toLowerCase()==='a' ? 'a' : 'b';
localStorage.setItem('mode', mode);
// 최종 EXEC: window.EXEC가 있으면 그걸 사용(가장 안전)
const EXEC = (window.EXEC && window.EXEC.trim()) || ((mode==='a')? EXEC_A : EXEC_B);

let tk = (localStorage.getItem('tk') || localStorage.getItem('teacherKey') || '').trim();
let schoolId='', classId='', roster=[];

// 문항 코드(대시보드 고정 7개)
const PROBLEMS = [
  '02_위험찾기','03_화재대피안전수칙','04_비상구로대피',
  '05_옷에불이붙었어요','06_119신고하기','07_소화기사용법','08_완강기사용법'
];

const $ = (id)=>document.getElementById(id);

/* JSONP */
function jsonp(url, timeout=15000){
  return new Promise((res,rej)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    let done=false;
    const t=setTimeout(()=>{ if(done)return; done=true; cleanup(); rej(new Error('timeout')); }, timeout);
    function cleanup(){ try{ delete window[cb]; s.remove(); }catch(_){ } clearTimeout(t); }
    window[cb] = (d)=>{ if(done) return; done=true; cleanup(); res(d); };
    const s=document.createElement('script');
    s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
    s.onerror = ()=>{ if(done)return; done=true; cleanup(); rej(new Error('network')); };
    document.body.appendChild(s);
  });
}

/* 상단 표시 */
function setHeader(){
  $('#modePill').textContent = (mode==='a')?'모드 A':'모드 B';
  $('#bindPill').textContent = tk? ('연결됨 · '+(schoolId||'')+'/'+(classId||'')) : '손님';
}

/* 기본 정보 */
async function init(){
  if(!EXEC){ alert('EXEC URL이 비어 있습니다. index.html?exec=<교사용 EXEC>로 다시 진입하세요.'); return; }
  if(!tk){ $('#klassInfo').textContent='먼저 바인드하세요.'; setHeader(); return; }

  try{
    const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'resolveKey', key:tk}));
    schoolId = r.schoolId||''; classId = r.classId||''; roster = Array.isArray(r.roster)? r.roster : [];
    setHeader();

    // 명단/부모코드 입력칸 복구
    $('#txtRoster').value = (roster||[]).join('\n');
    if(r.parentCode) $('#inputParentCode').value = r.parentCode;

    await loadPerformance();
    await loadRecent();
  }catch(_){
    alert('초기화 실패: EXEC 또는 네트워크를 확인하세요.');
  }
}

/* 성취표 */
async function loadPerformance(){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML='';
  const itemsByChild = {};

  try{
    const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'listByChild', key:tk}));
    const arr = (r && Array.isArray(r.items))? r.items : [];
    arr.forEach(it=>{
      const ch = (it.child||'').trim();
      const pr = (it.problem||'').trim();
      if(!itemsByChild[ch]) itemsByChild[ch] = {};
      const old = itemsByChild[ch][pr];
      if(!old || (+it.ts) > (+old.ts)) itemsByChild[ch][pr] = { fileId: it.fileId, ts:+it.ts, mime: it.mime };
    });
  }catch(_){}

  const names = [...(roster||[])];
  if(itemsByChild[''] && !names.includes('미분류')) names.push('미분류');

  const rows=[];
  names.forEach(n=>{
    const key = (n==='미분류') ? '' : n;
    rows.push(renderRow(n, itemsByChild[key]||{}));
  });
  Object.keys(itemsByChild).forEach(ch=>{
    if(ch && !names.includes(ch)) rows.push(renderRow(ch, itemsByChild[ch]));
  });

  rows.forEach(tr=>tbody.appendChild(tr));
  document.getElementById('noItems').style.display = rows.length? 'none' : 'block';
}

function renderRow(kidName, mapByProblem){
  const tr=document.createElement('tr');
  const tdName=document.createElement('td');
  tdName.textContent=kidName; tr.appendChild(tdName);

  PROBLEMS.forEach(p=>{
    const td=document.createElement('td');
    const it = mapByProblem[p];
    if(it){
      const a=document.createElement('a'); a.href='javascript:void(0)'; a.textContent='보기'; a.onclick=()=>openEditor(it.fileId);
      td.appendChild(a);
    }else{
      td.innerHTML='<span class="note">—</span>';
    }
    tr.appendChild(td);
  });
  return tr;
}

/* 최근 촬영 */
let RECENTS=[];
async function loadRecent(){
  const grid=document.getElementById('recentGrid');
  grid.innerHTML='';
  try{
    const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'listRecent', key:tk, limit: 120}));
    RECENTS = (r && Array.isArray(r.items))? r.items : [];
  }catch(_){ RECENTS=[]; }

  RECENTS.forEach(it=>{
    const c = (it.child||'').trim();
    const box = document.createElement('div'); box.className='thumbBox';
    const img = document.createElement('img'); img.alt = it.problem;
    img.onclick = ()=> openEditor(it.fileId);
    box.appendChild(img);
    const cap = document.createElement('div'); cap.className='cap';
    const d = new Date(+it.ts);
    cap.textContent = `[${it.problem||'-'}] ${c||'미분류'} · ${d.toLocaleString()}`;
    box.appendChild(cap);
    grid.appendChild(box);
    // 썸네일 로드
    (async ()=>{
      try{
        const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'thumbB64', fileId: it.fileId}));
        if(r && r.ok && r.b64) img.src='data:'+(r.mime||'image/jpeg')+';base64,'+r.b64;
      }catch(_){}
    })();
  });
}

/* 편집 모달 */
const modal = document.getElementById('modal');
const big   = document.getElementById('big');
const selChild = document.getElementById('selChild');
const selProb  = document.getElementById('selProb');
const btnDel   = document.getElementById('btnDel');
const btnSave  = document.getElementById('btnSave');
const btnClose = document.getElementById('btnClose');

function fillOptions(){
  selChild.innerHTML='';
  (roster||[]).forEach(n=>{
    const o=document.createElement('option'); o.value=n; o.textContent=n; selChild.appendChild(o);
  });
  selProb.innerHTML='';
  PROBLEMS.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; selProb.appendChild(o); });
}

async function openEditor(fileId){
  const it = RECENTS.find(x=>x.fileId===fileId);
  if(!it) return;
  fillOptions();
  selChild.value = (it.child||'').trim();
  selProb.value  = (it.problem||'').trim();
  big.src=''; // 프리로드
  // 원본 큰 이미지(썸네일이 아니라)
  try{
    const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'thumbB64', fileId: fileId}));
    if(r && r.ok && r.b64) big.src='data:'+(r.mime||'image/jpeg')+';base64,'+r.b64;
  }catch(_){}
  modal.style.display='flex';

  btnClose.onclick=()=>{ modal.style.display='none'; };
  btnSave.onclick = async ()=>{
    try{
      const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'reassignRecord', key:tk, fileId:fileId, child: selChild.value, problem: selProb.value}));
      if(r && r.ok){ modal.style.display='none'; await loadPerformance(); await loadRecent(); }
      else{ alert('저장 실패'); }
    }catch(_){ alert('네트워크 오류'); }
  };
  btnDel.onclick = async ()=>{
    if(!confirm('삭제할까요?')) return;
    try{
      const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'deleteRecord', key:tk, fileId:fileId}));
      if(r && r.ok){ modal.style.display='none'; await loadPerformance(); await loadRecent(); }
      else{ alert('삭제 실패'); }
    }catch(_){ alert('네트워크 오류'); }
  };
}

/* 버튼들 */
document.getElementById('btnRosterSave').onclick = async ()=>{
  if(!tk){ alert('먼저 로그인하세요.'); return; }
  const raw = (document.getElementById('txtRoster').value||'');
  try{
    const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'saveRoster', key:tk, roster: raw}));
    if(r && r.ok){
      roster = r.roster || [];
      alert('유아 명단 저장 완료');
      await loadPerformance(); await loadRecent();
    }else{ alert('저장 실패'); }
  }catch(_){ alert('네트워크 오류'); }
};

document.getElementById('btnParentSave').onclick = async ()=>{
  if(!tk){ alert('먼저 로그인하세요.'); return; }
  const pc = (document.getElementById('inputParentCode').value || '').trim();
  if(!pc){ alert('학부모 공용코드를 입력하세요.'); return; }
  try{
    const p = new URLSearchParams({action:'setParentCode', key:tk, parentCode: pc});
    let r = await jsonp(EXEC+'?'+p);
    if(r && r.ok){ alert('저장되었습니다.'); }
    else{ alert('저장 실패: '+((r&&r.error)||'server')); }
  }catch(_){ alert('네트워크 오류'); }
};

document.getElementById('btnUnlink').onclick = ()=>{
  if(!confirm('이 기기의 연결 정보를 삭제하고 손님모드로 전환합니다. 진행할까요?')) return;
  try{
    localStorage.removeItem('tk'); localStorage.removeItem('teacherKey');
    Object.keys(localStorage).forEach(k=>{ if(k.startsWith('faceDB::')) localStorage.removeItem(k); });
  }catch(_){}
  tk=''; setHeader(); alert('이 기기에서 연결이 해제되었습니다.');
};

init();
</script>
</body>
</html>
