<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ìº¡ì³</title>
<style>
:root{ --bg1:#dff0ff; --bg2:#eaf6ff; --ink:#0f172a; --btn:#0ea5e9; --btnD:#0284c7; --ok:#16a34a; --danger:#ef4444; }
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;color:var(--ink);background:linear-gradient(180deg,var(--bg1),var(--bg2))}
.wrap{min-height:100%;display:flex;align-items:center;justify-content:center;position:relative;padding:20px}

/* ìŠ¤í”Œë˜ì‹œ */
.splash{display:flex;flex-direction:column;align-items:center;gap:10px;text-align:center}
.splash img{width:min(38vh,320px);height:auto;display:block}
.splash .big{font-size:clamp(36px,8vw,80px);font-weight:900;letter-spacing:-.02em}
.splash .ok{color:var(--ok)}
.splash .note{color:#334155}

/* ì¹´ë©”ë¼ */
.camBox{display:none;flex-direction:column;align-items:center;gap:12px}
video{width:min(92vw,720px);height:auto;background:#111;border-radius:12px}
.actions{display:flex;gap:8px}
.btn{padding:12px 18px;border:0;border-radius:12px;color:#fff;font-weight:900;background:var(--btn);cursor:pointer}
.btn:hover{background:var(--btnD)}
.btn.alt{background:#0f172a}
.btn.danger{background:var(--danger)}

/* ì´ë¦„ ì„ íƒ */
.whoBox{width:min(1100px,96vw);max-height:26vh;overflow:auto;border:1px solid #cbd5e1;border-radius:14px;background:#fff;padding:10px;display:none}
.nameGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.nameBtn{padding:12px;border:1px solid #94a3b8;border-radius:12px;background:#f8fafc;font-weight:800;cursor:pointer;text-align:center}
.nameBtn.sel{outline:3px solid #0ea5e9;border-color:#0ea5e9;background:#e0f2fe}
.smallNote{font-size:12px;color:#334155;text-align:center;margin-top:6px}

/* ë‹«ê¸° */
.close{position:fixed;top:16px;right:16px;background:#0f172a;color:#fff;border:0;border-radius:999px;padding:8px 12px;font-weight:900;cursor:pointer}

/* ì™„ë£Œ ì˜¤ë²„ë ˆì´ */
#done{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.5);backdrop-filter:saturate(1.2) blur(2px)}
#done .box{background:#fff;border:1px solid #cbd5e1;border-radius:16px;padding:20px 24px;text-align:center}
#done .ok{color:var(--ok);font-size:20px;font-weight:900}
</style>
<body>
  <!-- EXEC Glue -->
  <script>
function closeSoon(){ try{ window.close(); }catch(_){ } setTimeout(function(){ history.back(); }, 500); }

    (function(){
      const q = new URLSearchParams(location.search);
      const paramExec = q.get('exec');
      const savedExec = localStorage.getItem('EXEC');
      const DEFAULT_EXEC = '';
      const EXEC = (paramExec && paramExec.trim()) || savedExec || DEFAULT_EXEC;
      if (EXEC && EXEC !== savedExec) localStorage.setItem('EXEC', EXEC);
      window.EXEC = EXEC;
      document.addEventListener('DOMContentLoaded', () => {
        if (!EXEC) return;
        document.querySelectorAll('a[href$=".html"]').forEach(a=>{
          try{
            const u = new URL(a.getAttribute('href'), location.href);
            if(!u.searchParams.get('exec')){
              u.searchParams.set('exec', EXEC);
              a.setAttribute('href', u.pathname + u.search);
            }
          }catch(_){}
        });
      });
    })();
  
(function(){
  try{
    var doneEl = document.getElementById('done');
    if(doneEl){
      var obs = new MutationObserver(function(){
        if(getComputedStyle(doneEl).display !== 'none'){
          setTimeout(closeSoon, 500);
        }
      });
      obs.observe(doneEl, {attributes:true, attributeFilter:['style','class']});
    }
  }catch(_){}
})();

</script>

  <button class="close" id="btnClose">ë‹«ê¸° Ã—</button>

  <div class="wrap">
    <!-- ìŠ¤í”Œë˜ì‹œ -->
    <div id="splash" class="splash">
      <img id="splashImg" alt="fire-key">
      <div class="big ok">FIRE KEY</div>
      <div class="note">ì„±ê³µì…ë‹ˆë‹¤. ê³§ ì¹´ë©”ë¼ê°€ ì¼œì ¸ìš”â€¦</div>
    </div>

    <!-- ì¹´ë©”ë¼ -->
    <div id="camBox" class="camBox">
      <video id="v" playsinline></video>
      <div class="actions">
        <button id="btnStart" class="btn alt">ì¹´ë©”ë¼ ë‹¤ì‹œ ì‹œì‘</button>
        <button id="btnShoot" class="btn">ì´¬ì˜</button>
        <button id="btnPick" class="btn">íŒŒì¼ ì„ íƒ</button>
        <input id="filePick" type="file" accept="image/*" style="display:none">
      </div>

      <!-- ìœ ì•„ ì´ë¦„ ì„ íƒ -->
      <div id="whoBox" class="whoBox">
        <div id="nameGrid" class="nameGrid"></div>
        <div id="noteNames" class="smallNote">â€» ì´ë¦„ì„ ê³ ë¥´ë©´ ë‹¤ìŒë¶€í„° ìë™ìœ¼ë¡œ ì„ íƒë©ë‹ˆë‹¤. ì„ íƒ ì•ˆ í•´ë„ ì €ì¥ë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <!-- ì™„ë£Œ ì˜¤ë²„ë ˆì´ -->
  <div id="done">
    <div class="box">
      <div class="ok">ì—…ë¡œë“œ ì„±ê³µ!</div>
      <div style="margin-top:6px;color:#334155">í˜ì´ì§€ê°€ ê³§ ë‹«í™ë‹ˆë‹¤â€¦</div>
    </div>
  </div>

<script>
/* ===== ì„¤ì •/ìƒìˆ˜ ===== */
const EXEC_A='REPLACE_WITH_NEW_EXEC_A';
const EXEC_B='REPLACE_WITH_NEW_EXEC_B';
const qs=new URLSearchParams(location.search);
const mode=(qs.get('mode')||localStorage.getItem('mode')||'b').toLowerCase()==='a'?'a':'b';
const EXEC=window.EXEC||((mode==='a')?EXEC_A:EXEC_B);
const problem=qs.get('problem')||'';
let tk=(qs.get('tk')||localStorage.getItem('tk')||localStorage.getItem('teacherKey')||'').trim();
if(qs.get('tk')){ localStorage.setItem('tk',tk); localStorage.setItem('teacherKey',tk); }
localStorage.setItem('mode',mode);

const $=id=>document.getElementById(id);
const splash=$('splash'), camBox=$('camBox'), video=$('v'),
      whoBox=$('whoBox'), grid=$('nameGrid'), noteNames=$('noteNames'),
      btnStart=$('btnStart'), btnShoot=$('btnShoot'),
      btnPick=$('btnPick'), filePick=$('filePick');
let stream=null, roster=[], selected='';

// ğŸ” ìë™ê¸°ì–µ í‚¤
const LS_LAST_CHILD_KEY = (tk?('lastChild_'+tk):'lastChild');

/* ===== ìŠ¤í”Œë˜ì‹œ ì´ë¯¸ì§€ (ì›ë˜ ê²½ë¡œë¡œ ë³µì›) ===== */
const FIRE_IMG = '/teacherhome/fire-key.png';
document.getElementById('splashImg').src = FIRE_IMG;

/* ===== JSONP ìœ í‹¸ ===== */
function jsonp(url, timeout=15000){
  return new Promise((res,rej)=>{
    const cb='cb_'+Math.random().toString(36).slice(2); let done=false;
    const t=setTimeout(()=>{ if(done)return; done=true; cleanup(); rej(new Error('timeout')); }, timeout);
    function cleanup(){ try{ delete window[cb]; s.remove(); }catch(_){ } clearTimeout(t); }
    window[cb]=d=>{ if(done)return; done=true; cleanup(); res(d); };
    const s=document.createElement('script');
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb; s.onerror=()=>{ if(done)return; done=true; cleanup(); rej(new Error('network')); };
    document.body.appendChild(s);
  });
}

/* ===== ì„œë²„ ë°˜ì˜ í™•ì¸ ===== */
async function waitServerWrite(t0, tries=3){
  for(let i=0;i<tries;i++){
    await new Promise(r=>setTimeout(r, 800));
    try{
      const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'listByChild', key: tk}));
      const items = (r && Array.isArray(r.items)) ? r.items : [];
      if(items.some(it => Number(it.ts||0) >= (t0-3000))) return true;
    }catch(_){}
  }
  return false;
}

/* ===== ì¹´ë©”ë¼ ===== */
async function startCam(){
  try{
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject=stream; await video.play();
    camBox.style.display='flex';
  }catch(e){
    alert('ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ì„ íƒìœ¼ë¡œ ì§„í–‰í•´ ì£¼ì„¸ìš”.');
    camBox.style.display='flex';
  }
}
function stopCam(){ try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }catch(_){}

/* ===== ì´ë¦„ ëª©ë¡ ===== */
async function loadRoster(){
  try{
    const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'resolveKey', key: tk}));
    roster = (r && Array.isArray(r.roster)) ? r.roster : [];
    grid.innerHTML='';
    if(roster.length){
      const last = localStorage.getItem(LS_LAST_CHILD_KEY)||'';
      roster.forEach((name,idx)=>{
        const b=document.createElement('button');
        b.className='nameBtn'; b.textContent=(idx+1).toString().padStart(2,'0')+' '+name;
        b.onclick=()=>{ selected=name; localStorage.setItem(LS_LAST_CHILD_KEY, selected);
                        document.querySelectorAll('.nameBtn').forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); };
        if(last && last===name){ selected=name; b.classList.add('sel'); }
        grid.appendChild(b);
      });
      whoBox.style.display='block';
      noteNames.style.display='block';
    }else{
      whoBox.style.display='none';
      noteNames.style.display='none';
    }
  }catch(_){}
}

/* ===== ì´ˆê¸° êµ¬ë™ ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  if(!tk || !EXEC || !problem){ alert('í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½(tk/exec/problem)'); return; }
  await loadRoster();
  // âœ… ìŠ¤í”Œë˜ì‹œ í›„ ì¹´ë©”ë¼ ì‹œì‘: 0.5ì´ˆ
  setTimeout(()=>{ startCam().catch(()=>{}); }, 500);
});

/* ===== ì´¬ì˜/ì—…ë¡œë“œ ===== */
$('btnStart').onclick=()=>startCam();

$('btnShoot').onclick=async()=>{
  try{
    // ìº”ë²„ìŠ¤ ìŠ¤ëƒ…ìƒ·
    const c=document.createElement('canvas'); c.width=video.videoWidth||1280; c.height=video.videoHeight||720;
    const ctx=c.getContext('2d'); ctx.drawImage(video,0,0,c.width,c.height);
    const dataURL=c.toDataURL('image/jpeg',0.92), mime='image/jpeg', filename='cap_'+Date.now()+'.jpg';

    // âœ… ìë™ë¶„ë¥˜: ì„ íƒ ì•ˆ í–ˆì–´ë„ ë§ˆì§€ë§‰ ê¸°ì–µê°’ì„ childë¡œ ì±„ì›Œ ì—…ë¡œë“œ
    const remembered = localStorage.getItem(LS_LAST_CHILD_KEY)||'';
    const child = (selected || remembered || '');

    if(child) localStorage.setItem(LS_LAST_CHILD_KEY, child);

    const t0 = Date.now();
    await uploadBase64(dataURL,mime,filename,child);

    const ok = await waitServerWrite(t0, 3);
    if(!ok){
      alert('ì„œë²„ ë°˜ì˜ì„ í™•ì¸í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\nâ‘  ìº¡ì³/ëŒ€ì‹œë³´ë“œ EXEC ë™ì¼\nâ‘¡ TK ì¼ì¹˜ ì—¬ë¶€ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.');
      return;
    }
    stopCam(); document.getElementById('done').style.display='flex'; setTimeout(tryClose, 500); // âœ… 0.5ì´ˆ ë’¤ ìë™ ë‹«ê¸°
  }catch(e){ alert('ì—…ë¡œë“œ ì‹¤íŒ¨'); console.error(e); }
};

$('btnPick').onclick = ()=>filePick.click();
filePick.onchange = async ()=>{
  const f=filePick.files[0]; if(!f) return;
  const mime=f.type||'image/jpeg', filename=f.name||('file_'+Date.now()+'.jpg');
  const dataURL=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
  const remembered = localStorage.getItem(LS_LAST_CHILD_KEY)||'';
  const child = (selected || remembered || '');
  if(child) localStorage.setItem(LS_LAST_CHILD_KEY, child);
  const t0=Date.now();
  await uploadBase64(dataURL,mime,filename,child);
  const ok = await waitServerWrite(t0,3);
  if(!ok){ alert('ì„œë²„ ë°˜ì˜ í™•ì¸ ì‹¤íŒ¨. EXEC/TKë¥¼ í™•ì¸í•˜ì„¸ìš”.'); return; }
  document.getElementById('done').style.display='flex'; setTimeout(tryClose, 500); // âœ… 0.5ì´ˆ ë’¤ ìë™ ë‹«ê¸°
};

async function uploadBase64(dataURL,mime,filename,child){
  const fd=new FormData();
  fd.append('action','uploadSuccess'); fd.append('key',tk); fd.append('problem',problem); fd.append('child',child||'');
  fd.append('ts',Date.now()); fd.append('file_b64',(dataURL||'').split(',')[1]||''); fd.append('mime',mime); fd.append('filename',filename);
  await fetch(EXEC,{method:'POST',body:fd,mode:'no-cors'});
}

/* ===== ë‹«ê¸° ë™ì‘ ë³´ê°• ===== */
function tryClose(){
  try{ window.close(); }catch(_){}
  setTimeout(()=>{
    try{
      if (history.length > 1) { history.back(); }
      else { window.location.replace('about:blank'); }
    }catch(_){
      window.location.href = 'about:blank';
    }
  }, 200);
}
document.getElementById('btnClose').addEventListener('click', (e)=>{ e.preventDefault(); tryClose(); });
</script>
</body>
</html>
