<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>캡쳐</title>
<style>
:root{ --bg1:#dff0ff; --bg2:#eaf6ff; --ink:#0f172a; --btn:#0ea5e9; --btnD:#0284c7; --ok:#16a34a; --danger:#ef4444; }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;color:var(--ink);
  background:linear-gradient(180deg,var(--bg1),var(--bg2))}
.wrap{min-height:100%;display:flex;align-items:center;justify-content:center;position:relative;padding:20px}

/* 스플래시 */
.splash{display:flex;flex-direction:column;align-items:center;gap:16px;text-align:center}
.splash img{width:min(38vh,320px);height:auto;display:block}
.title{font-size:clamp(32px,8vw,80px);font-weight:900;letter-spacing:-.02em}
#autoHint{font-size:12px;color:#334155}

/* 카메라 */
#camBox{display:none;flex-direction:column;align-items:center;gap:12px}
video{width:min(96vw,1000px);height:auto;border-radius:16px;background:#000}
.controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.btn{padding:12px 18px;border:0;border-radius:12px;color:#fff;font-weight:900;background:var(--btn);cursor:pointer}
.btn:hover{background:var(--btnD)} .btn.ok{background:var(--ok)} .btn.danger{background:var(--danger)}

/* 이름 선택 그리드 */
.whoBox{width:min(1000px,96vw);max-height:30vh;overflow:auto;border:1px solid #cbd5e1;border-radius:14px;background:#fff;padding:10px}
.nameGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.nameBtn{padding:12px;border:1px solid #94a3b8;border-radius:12px;background:#f8fafc;font-weight:800;cursor:pointer;text-align:center}
.nameBtn.sel{outline:3px solid #0ea5e9;border-color:#0ea5e9;background:#e0f2fe}
.smallNote{font-size:12px;color:#334155;text-align:center;margin-top:6px}

/* 상단 닫기 */
.close{position:fixed;top:16px;right:16px;background:#0f172a;color:#fff;border:0;border-radius:999px;padding:10px 14px;font-weight:900;cursor:pointer}

/* 성공 오버레이 */
#done{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:10}
.card{background:#fff;border-radius:16px;padding:24px 20px;text-align:center;max-width:min(92vw,700px)}
.card h2{margin:0 0 10px;font-size:clamp(36px,10vw,92px)}
.card p{margin:0}
</style>
<body>
<button class="close" onclick="window.history.back()">닫기 ×</button>

<div class="wrap">
  <!-- 스플래시 -->
  <div id="splash" class="splash">
    <img id="splashImg" alt="안전 열쇠">
    <div style="font-size:22px;margin-top:2px">안전 열쇠</div>
    <div class="title">성공입니다!</div>
    <div id="autoHint"></div>
  </div>

  <!-- 이름 선택 + 카메라 -->
  <div id="camBox">
    <div class="whoBox">
      <div class="nameGrid" id="nameGrid"></div>
    </div>
    <div class="smallNote">* 기본 선택은 <b id="klassName">(학급명)</b> 입니다. 그대로 촬영하면 <b>미분류</b>로 업로드되며, 교사가 대시보드에서 분류할 수 있습니다.</div>

    <video id="v" playsinline muted></video>
    <div class="controls">
      <button class="btn" id="btnStart">카메라 시작</button>
      <button class="btn ok" id="btnShoot">촬영 & 업로드</button>
      <input type="file" id="filePick" accept="image/*" capture="user" style="display:none"/>
      <button class="btn" id="btnPick">사진 선택(폴백)</button>
    </div>
  </div>
</div>

<!-- 업로드 성공 -->
<div id="done">
  <div class="card"><h2>성공입니다!</h2><p>업로드가 완료되었습니다.</p></div>
</div>

<!-- 얼굴 임베딩 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script>
/* ---------- 고정 리소스 경로 ---------- */
const FIRE_IMG_ABS = '/teacherhome/fire-key.png'; // 저장소 루트
document.getElementById('splashImg').src = FIRE_IMG_ABS;

/* ---------- 실행 URL ---------- */
const EXEC_A="https://script.google.com/macros/s/AKfycby4camh7UDnlV4ElL3eJPUUWvslSAtfyssAQBRfizcY9D1MRJK9r_O0ZYDnQvKryalG/exec";
const EXEC_B="https://script.google.com/macros/s/AKfycbzNUWjOhh3V-Cu2WYkl6voDKoAHFKjOl_OQbKH6rQYj6o8K06YoQmc0D7Q6WMJJ-Foz/exec";

/* ---------- 파라미터 & 상태 ---------- */
const qs=new URLSearchParams(location.search);
const mode=(qs.get('mode')||localStorage.getItem('mode')||'b').toLowerCase()==='a'?'a':'b';
const EXEC=(mode==='a')?EXEC_A:EXEC_B;
const problem = qs.get('problem') || ''; // 필수
let tk = (qs.get('tk') || localStorage.getItem('tk') || localStorage.getItem('teacherKey') || '').trim();
if(qs.get('tk')){ localStorage.setItem('tk', tk); localStorage.setItem('teacherKey', tk); }

const $=id=>document.getElementById(id);
const splash=$('splash'), camBox=$('camBox'), video=$('v'), grid=$('nameGrid'), autoHint=$('autoHint');
const btnStart=$('btnStart'), btnShoot=$('btnShoot'), btnPick=$('btnPick'), filePick=$('filePick');
let stream=null, klass='', roster=[], selected='';

/* ---------- JSONP ---------- */
function jsonp(url, timeout=15000){
  return new Promise((res,rej)=>{
    const cb='cb_'+Math.random().toString(36).slice(2); let done=false;
    const t=setTimeout(()=>{ if(done)return; done=true; cleanup(); rej(new Error('timeout')); }, timeout);
    function cleanup(){ try{ delete window[cb]; s.remove(); }catch(_){ } clearTimeout(t); }
    window[cb]=d=>{ if(done)return; done=true; cleanup(); res(d); };
    const s=document.createElement('script');
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb; s.onerror=()=>{ if(done)return; done=true; cleanup(); rej(new Error('network')); };
    document.body.appendChild(s);
  });
}

/* ---------- face-api.js 모델 로드 ---------- */
const FACEAPI_MODELS = 'https://justadudewhohacks.github.io/face-api.js/models';
let modelsReady = false;
async function loadFaceModels(){
  try{
    await Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri(FACEAPI_MODELS),
      faceapi.nets.faceLandmark68Net.loadFromUri(FACEAPI_MODELS),
      faceapi.nets.faceRecognitionNet.loadFromUri(FACEAPI_MODELS),
    ]);
    modelsReady = true;
    autoHint.textContent = '자동분류 준비 완료(이 기기 전용). 처음 1~2회 이름 지정 후 자동분류됩니다.';
  }catch(e){
    autoHint.textContent = '자동분류 준비 실패(네트워크). 수동 선택으로 이용하세요.';
    console.warn(e);
  }
}
loadFaceModels();

/* ---------- 로컬 얼굴DB(센트로이드) ---------- */
const THRESH = 0.83; // 코사인 유사도 임계값
function dbKey(){ return 'faceDB::'+(tk||''); }
function loadDB(){ try{ return JSON.parse(localStorage.getItem(dbKey())||'{}'); }catch(_){ return {}; } }
function saveDB(db){ localStorage.setItem(dbKey(), JSON.stringify(db)); }
function cos(a,b){ let dot=0,na=0,nb=0; const n=Math.min(a.length,b.length); for(let i=0;i<n;i++){ dot+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i]; } return dot/(Math.sqrt(na)*Math.sqrt(nb)+1e-9); }
function ema(oldV, newV, alpha=0.85){ const n=Math.min(oldV.length,newV.length), out=new Array(n); for(let i=0;i<n;i++) out[i]=alpha*oldV[i]+(1-alpha)*newV[i]; return out; }
function updateCentroid(child, desc){ if(!child||!desc) return; const db=loadDB(); const cur=db[child]; if(cur && Array.isArray(cur.vec)){ db[child]={vec:ema(cur.vec,desc,0.85), n:(cur.n||1)+1}; } else { db[child]={vec:Array.from(desc), n:1}; } saveDB(db); }
function predict(desc){ const db=loadDB(); let best='',score=-1; for(const name in db){ const s=cos(db[name].vec, desc); if(s>score){ score=s; best=name; } } return (best && score>=THRESH) ? {child:best, score} : null; }

/* ---------- 이름 그리드 ---------- */
function renderNames(){
  grid.innerHTML='';
  const makeBtn=(name,isClass=false)=>{
    const b=document.createElement('button');
    b.type='button'; b.className='nameBtn'+(selected===name?' sel':'');
    b.textContent=isClass?`${name} (기본)` : name;
    b.onclick=()=>{ selected=name; renderNames(); };
    grid.appendChild(b);
  };
  if(klass){ makeBtn(klass,true); $('klassName').textContent=klass; if(!selected) selected=klass; }
  (roster||[]).forEach(n=>{ if(n && n!==klass) makeBtn(n,false); });
}

/* ---------- 카메라 ---------- */
async function startCam(){
  try{
    const constraints={ audio:false, video:{ facingMode:{ideal:'user'}, width:{ideal:1280}, height:{ideal:720} } };
    stream=await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=stream; await video.play();
    splash.style.display='none'; camBox.style.display='flex';
  }catch(e){
    camBox.style.display='flex';
    alert('카메라 접근이 차단되어 파일 선택으로 전환합니다. 주소창의 자물쇠 아이콘에서 권한을 허용해 주세요.');
  }
}
function stopCam(){ try{ stream && stream.getTracks().forEach(t=>t.stop()); }catch(_){} stream=null; }

/* ---------- 자동 시작 & 자동선택(고신뢰) ---------- */
(async ()=>{
  if(tk){
    try{
      const j=await jsonp(EXEC+'?'+new URLSearchParams({action:'resolveKey',key:tk}));
      roster = (j && Array.isArray(j.roster)) ? j.roster : [];
      klass  = (j && j.classId) || '';
    }catch(_){}
  }
  renderNames();
  if(problem && tk){ setTimeout(()=>startCam().catch(()=>{}), 1200); }
})();

/* ---------- 버튼 ---------- */
btnStart.onclick=()=>startCam();
btnPick.onclick =()=>filePick.click();

/* ---------- 비디오 프레임 → 디스크립터 ---------- */
async function getVideoDescriptor(){
  if(!modelsReady) return null;
  const detOpts = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 });
  const res = await faceapi.detectSingleFace(video, detOpts).withFaceLandmarks().withFaceDescriptor();
  return res && res.descriptor ? Array.from(res.descriptor) : null;
}

/* ---------- 촬영 & 업로드(base64 + A모드 임베딩 훅) ---------- */
btnShoot.onclick=async ()=>{
  try{
    // 1) 캡쳐
    let dataURL=null, mime='image/jpeg', filename='capture.jpg';
    if(stream){
      const cv=document.createElement('canvas');
      const vw=video.videoWidth, vh=video.videoHeight;
      cv.width=vw; cv.height=vh;
      cv.getContext('2d').drawImage(video,0,0,vw,vh);
      dataURL=cv.toDataURL('image/jpeg',0.92);
    }else{
      if(!filePick.files.length){ alert('파일을 선택해 주세요.'); return; }
      const f=filePick.files[0]; filename=f.name||filename; mime=f.type||mime;
      dataURL=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
    }

    // 2) 자동선택 시도(고신뢰)
    let child = selected||klass||'';
    let desc = null, embedCSV = '';
    if(modelsReady){
      try{
        // 비디오일 때만 프레임에서 임베딩 산출(파일 업로드 폴백일 때는 생략)
        if(stream) desc = await getVideoDescriptor();
        if(desc){
          // 고신뢰 매칭이면 자동선택
          const guess = predict(desc);
          if(guess && (!child || child===klass)){ child = guess.child; autoHint.textContent = `자동선택: ${child} (신뢰 ${guess.score.toFixed(2)})`; }
          // 로컬 학습(교사가 이름을 직접 선택했든 자동이든 child가 확정되면 업데이트)
          if(child && child!==klass) updateCentroid(child, desc);
          // A모드 호환: 임베딩을 서버에도 전달(문자열 CSV)
          embedCSV = desc.join(',');
        }
      }catch(_){}
    }
    // 기본(학급명) 그대로면 미분류로 올림(빈 값)
    if(child===klass) child='';

    // 3) 업로드
    await uploadBase64(dataURL,mime,filename,child,embedCSV);

    // 4) 성공 UI
    stopCam(); $('done').style.display='flex'; setTimeout(()=>{ $('done').style.display='none'; },1400);
  }catch(e){ alert('업로드 실패: 네트워크/권한 문제일 수 있습니다.'); console.error(e); }
};
filePick.onchange=()=>{ if(filePick.files.length) btnShoot.click(); };

async function uploadBase64(dataURL,mime,filename,child,embedCSV){
  const fd=new FormData();
  fd.append('action','uploadSuccess');
  fd.append('key', tk);
  fd.append('problem', problem);
  fd.append('child', child);          // ''이면 미분류
  fd.append('ts', Date.now());
  fd.append('file_b64',(dataURL||'').split(',')[1]||'');
  fd.append('mime', mime||'image/jpeg');
  fd.append('filename', filename||('capture_'+Date.now()+'.jpg'));
  if(mode==='a' && embedCSV) fd.append('embed_csv', embedCSV); // A모드 자동분류용(선택)
  await fetch(EXEC,{method:'POST',body:fd,mode:'no-cors'});
}
</script>
</body>
</html>
