<!doctype html>
<html lang="ko">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>안전 열쇠 · 캡쳐</title>
<style>
:root{--bg1:#dff0ff;--bg2:#eaf6ff;--ink:#0f172a;--btn:#0f172a;--btnInk:#fff}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:system-ui,-apple-system,'Segoe UI',Roboto,sans-serif;overflow:hidden}
.wrap{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:16px;gap:16px}
.logo{display:flex;flex-direction:column;align-items:center;gap:8px}
.logo img{width:min(26vw,220px);height:auto;display:block}
.logo h1{margin:0;font-weight:900;font-size:clamp(22px,4vw,42px)}
.btn{padding:12px 16px;border-radius:14px;border:0;background:var(--btn);color:var(--btnInk);font-weight:900;cursor:pointer}
.topright{position:fixed;right:14px;top:14px;z-index:50}
.hidden{display:none}
.stage{display:flex;gap:16px;align-items:center;justify-content:center;flex-wrap:wrap}
video,canvas,.preview{background:#000;border-radius:16px;max-height:64vh;max-width:90vw}
.controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.overlay{position:fixed;inset:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));display:none;align-items:center;justify-content:center;z-index:100}
.overlay.show{display:flex}
.card{display:flex;flex-direction:column;align-items:center;gap:16px;max-width:92vw}
.card h2{margin:0;font-weight:900;letter-spacing:-0.5px;font-size:clamp(36px,9vw,96px)}
.card img{border-radius:20px;max-width:92vw;max-height:70vh;object-fit:cover}
.portrait .stage{flex-direction:column}
.portrait video,.portrait canvas,.portrait .preview{max-width:92vw;max-height:70vh}
</style>
<body>
<button class="btn topright" id="btnClose">닫기 ×</button>

<div class="wrap" id="splash">
  <div class="logo">
    <img id="logoImg" alt="안전 열쇠">
    <h1>안전 열쇠</h1>
  </div>
</div>

<div class="wrap hidden" id="main">
  <div class="stage">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas" class="hidden"></canvas>
    <img id="preview" class="preview hidden" alt="미리보기">
  </div>
  <div class="controls">
    <button class="btn" id="btnShot">촬영</button>
    <button class="btn hidden" id="btnRetake">다시 찍기</button>
    <button class="btn hidden" id="btnUpload">업로드</button>
  </div>
</div>

<div class="overlay" id="ok">
  <div class="card">
    <img id="okImg" alt="성공 사진">
    <h2>성공입니다!</h2>
  </div>
</div>

<script>
const EXEC_A="https://script.google.com/macros/s/AKfycby4camh7UDnlV4ElL3eJPUUWvslSAtfyssAQBRfizcY9D1MRJK9r_O0ZYDnQvKryalG/exec";
const EXEC_B="https://script.google.com/macros/s/AKfycbzNUWjOhh3V-Cu2WYkl6voDKoAHFKjOl_OQbKH6rQYj6o8K06YoQmc0D7Q6WMJJ-Foz/exec";
const qs=new URLSearchParams(location.search);
const mode=(qs.get('mode')||localStorage.getItem('mode')||'b').toLowerCase()==='a'?'a':'b'; localStorage.setItem('mode',mode);
const EXEC=(mode==='a')?EXEC_A:EXEC_B;
const problem=(qs.get('problem')||'').trim();
const is119 = (problem.includes('119') || qs.get('portrait')==='1');

<script>
  window.FIRE_IMG_ABS = "https://seol-glitter.github.io/teacherhome/fire-key.png";
</script>

// 로고 경로 폴백 + 절대강제(원하면 FIRE_IMG_ABS 지정)
const FIRE_IMG_CANDIDATES=[window.FIRE_IMG_ABS, './images/fire-key.png','../images/fire-key.png','/images/fire-key.png'].filter(Boolean);
(function(){ const img=document.getElementById('logoImg'); let i=0; function next(){ if(i>=FIRE_IMG_CANDIDATES.length){img.remove();return;} img.src=FIRE_IMG_CANDIDATES[i++]; } img.onerror=next; next(); })();

// tk 감지(모든 키명+URL 허용)
const tk=((localStorage.getItem('tk')||localStorage.getItem('teacherKey')||qs.get('tk')||'').trim());

// UI
const $=id=>document.getElementById(id), $splash=$('splash'), $main=$('main');
if(is119) document.body.classList.add('portrait');
$('btnClose').onclick=()=>{ if(history.length>1) history.back(); else window.close(); };

// 카메라
let stream=null, shotBlob=null, shotURL=null;
async function startCam(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
    $('video').srcObject=stream;
  }catch(e){ fileFallback(); }
}
function stopCam(){ try{ stream && stream.getTracks().forEach(t=>t.stop()); }catch(_){ } }
function fileFallback(){
  const input=document.createElement('input'); input.type='file'; input.accept='image/*'; input.capture='user';
  input.onchange=()=>{ const f=input.files&&input.files[0]; if(!f) return; shotBlob=f; shotURL=URL.createObjectURL(f); $('preview').src=shotURL; $('preview').classList.remove('hidden'); $('video').classList.add('hidden'); $('btnShot').classList.add('hidden'); $('btnRetake').classList.remove('hidden'); $('btnUpload').classList.remove('hidden'); };
  input.click();
}
function snap(){
  const v=$('video'), c=$('canvas'), w=v.videoWidth, h=v.videoHeight; if(!w||!h) return;
  c.width=w; c.height=h; c.getContext('2d').drawImage(v,0,0,w,h);
  c.toBlob(b=>{ shotBlob=b; if(shotURL) URL.revokeObjectURL(shotURL); shotURL=URL.createObjectURL(b); $('preview').src=shotURL; $('preview').classList.remove('hidden'); $('btnRetake').classList.remove('hidden'); $('btnUpload').classList.remove('hidden'); }, 'image/jpeg', .92);
}
async function upload(){
  if(!shotBlob) return;
  const fd=new FormData(); fd.append('action','uploadSuccess'); fd.append('key',tk); fd.append('problem',problem); fd.append('ts',Date.now()); fd.append('file',shotBlob,'capture.jpg');
  try{
    const r=await fetch(EXEC,{method:'POST',body:fd,mode:'cors'}); const j=await r.json();
    if(j&&j.ok){ $('okImg').src=shotURL; $('ok').classList.add('show'); stopCam(); }
    else{ alert('업로드 실패: '+((j&&j.error)||'')); }
  }catch(_){ alert('네트워크 오류: 업로드 실패'); }
}
function armIfReady(){
  if(tk && problem){
    setTimeout(async()=>{ $splash.classList.add('hidden'); $main.classList.remove('hidden'); await startCam(); }, 1400);
  }else{
    // 손님 문구 제거: 스플래시만 정적 표시
  }
}
$('btnShot').onclick=snap;
$('btnRetake').onclick=()=>{ $('preview').classList.add('hidden'); $('btnRetake').classList.add('hidden'); $('btnUpload').classList.add('hidden'); $('btnShot').classList.remove('hidden'); };
$('btnUpload').onclick=upload;
armIfReady();
</script>
</body>
</html>
