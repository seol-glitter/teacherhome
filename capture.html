<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ìº¡ì³</title>
<style>
:root{ --bg1:#dff0ff; --bg2:#eaf6ff; --ink:#0f172a; --btn:#0ea5e9; --btnD:#0284c7; --ok:#16a34a; --danger:#ef4444; }
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;color:var(--ink);background:linear-gradient(180deg,var(--bg1),var(--bg2))}
.wrap{min-height:100%;display:flex;align-items:center;justify-content:center;position:relative;padding:20px}

/* ìŠ¤í”Œë˜ì‹œ */
.splash{display:flex;flex-direction:column;align-items:center;gap:10px;text-align:center}
.splash img{width:min(38vh,320px);height:auto;display:block}
.splash .big{font-size:clamp(36px,8vw,80px);font-weight:900;letter-spacing:-.02em}

/* ì¹´ë©”ë¼ */
#camBox{display:none;flex-direction:column;align-items:center;gap:12px;width:100%}
video{width:min(96vw,1100px);height:auto;border-radius:16px;background:#000}
.controls{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;align-items:center;margin-top:6px}
.btn{padding:12px 18px;border:0;border-radius:12px;color:#fff;font-weight:900;background:var(--btn);cursor:pointer}
.btn:hover{background:var(--btnD)}
.btn.alt{background:#0f172a}
.btn.danger{background:var(--danger)}

/* ì´ë¦„ ì„ íƒ(í•™ê¸‰ ë²„íŠ¼ ì œê±°, ìœ ì•„ë§Œ) */
.whoBox{width:min(1100px,96vw);max-height:26vh;overflow:auto;border:1px solid #cbd5e1;border-radius:14px;background:#fff;padding:10px;display:none}
.nameGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.nameBtn{padding:12px;border:1px solid #94a3b8;border-radius:12px;background:#f8fafc;font-weight:800;cursor:pointer;text-align:center}
.nameBtn.sel{outline:3px solid #0ea5e9;border-color:#0ea5e9;background:#e0f2fe}
.smallNote{font-size:12px;color:#334155;text-align:center;margin-top:6px}

/* ë‹«ê¸° */
.close{position:fixed;top:16px;right:16px;background:#0f172a;color:#fff;border:0;border-radius:999px;padding:10px 14px;font-weight:900;cursor:pointer;z-index:99}

/* ì„±ê³µ ì˜¤ë²„ë ˆì´ */
#done{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:10}
.card{background:#fff;border-radius:16px;padding:24px 20px;text-align:center;max-width:min(92vw,700px)}
.card h2{margin:0 0 10px;font-size:clamp(36px,10vw,92px)}
.card p{margin:0}

/* ì•„ì´ ì „ìš© ì…”í„°(ì¹´ë©”ë¼ ì•„ì´ì½˜) */
.shutter{width:min(18vw,110px);height:min(18vw,110px);min-width:84px;min-height:84px;border-radius:999px;border:none;cursor:pointer;background:var(--ok);display:inline-flex;align-items:center;justify-content:center;box-shadow:0 10px 24px rgba(0,0,0,.25)}
.shutter:active{transform:scale(.98)} .shutter svg{width:55%;height:55%;fill:#fff;display:block}
</style>
<body>
<script>
/* EXEC Glue v1 â€” ëª¨ë“  í˜ì´ì§€ì—ì„œ ë™ì¼ EXEC ìœ ì§€ */
(function () {
  const q = new URLSearchParams(location.search);
  const paramExec = q.get('exec');
  const savedExec = localStorage.getItem('EXEC');
  const DEFAULT_EXEC = ''; // (ì„ íƒ) ë¹„ì›Œë‘ê³ , ì²« ì§„ì…ì€ ë°˜ë“œì‹œ ?exec=... ë¡œ ë“¤ì–´ì˜¤ê²Œ í•¨

  // 1) ê²°ì •
  const EXEC = (paramExec && paramExec.trim()) || savedExec || DEFAULT_EXEC;
  if (!EXEC) {
    console.warn('[EXEC] not set. Append ?exec=<teacher-exec> to URL once.');
  }
  // 2) ì €ì¥
  if (EXEC && EXEC !== savedExec) localStorage.setItem('EXEC', EXEC);
  // 3) ì „ì—­ ë…¸ì¶œ
  window.EXEC = EXEC;

  // 4) ë‚´ë¶€ í˜ì´ì§€ ì´ë™(a[href$=".html"])ì— exec ìë™ ë¶€ì°©
  document.addEventListener('DOMContentLoaded', () => {
    if (!EXEC) return;
    document.querySelectorAll('a[href$=".html"]').forEach(a => {
      const u = new URL(a.getAttribute('href'), location.href);
      if (!u.searchParams.get('exec')) {
        u.searchParams.set('exec', EXEC);
        a.setAttribute('href', u.pathname + u.search);
      }
    });
  });
})();
</script>

<button class="close" onclick="history.back()">ë‹«ê¸° Ã—</button>

<div class="wrap">
  <!-- ìŠ¤í”Œë˜ì‹œ -->
  <div id="splash" class="splash">
    <img id="splashImg" alt="fire-key">
    <div class="big">ì„±ê³µì…ë‹ˆë‹¤!</div>
  </div>

  <!-- ì¹´ë©”ë¼/ì´ë¦„ -->
  <div id="camBox">
    <div class="whoBox" id="whoBox"><div class="nameGrid" id="nameGrid"></div></div>
    <div class="smallNote" id="noteNames" style="display:none">* ì´ë¦„ì„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ <b>ë¯¸ë¶„ë¥˜</b>ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>

    <video id="v" playsinline muted></video>
    <div class="controls">
      <button class="btn alt" id="btnStart">ì¹´ë©”ë¼ ë‹¤ì‹œ ì‹œì‘</button>
      <button class="shutter" id="btnShoot" aria-label="ì´¬ì˜">
        <svg viewBox="0 0 24 24"><path d="M9.5 5h5l1.3 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h4.2L9.5 5zm2.5 12a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9z"/></svg>
      </button>
      <!-- í´ë°±(ì •ë§ ì•ˆ ë  ë•Œë§Œ ë…¸ì¶œ) -->
      <input type="file" id="filePick" accept="image/*" capture="user" style="display:none"/>
      <button class="btn" id="btnPick" style="display:none">ì‚¬ì§„ ì„ íƒ(í´ë°±)</button>
    </div>
  </div>
</div>

<div id="done"><div class="card"><h2>ì„±ê³µì…ë‹ˆë‹¤!</h2><p>ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p></div></div>

<script>
// ğŸ” ì—¬ê¸° 2ê°œ URLì€ **ìƒˆë¡œ ë°°í¬í•œ** ì›¹ì•± URLë¡œ êµì²´í•˜ì„¸ìš”!
const EXEC_A="https://script.google.com/macros/s/REPLACE_WITH_NEW_A/exec";
const EXEC_B="https://script.google.com/macros/s/REPLACE_WITH_NEW_B/exec";

// ë¶ˆëŸ¬ì˜¤ê¸°
const FIRE_IMG = '/teacherhome/fire-key.png'; // ì €ì¥ì†Œ ë£¨íŠ¸ ê²½ë¡œ
document.getElementById('splashImg').src = FIRE_IMG;

const qs=new URLSearchParams(location.search);
const mode=(qs.get('mode')||localStorage.getItem('mode')||'b').toLowerCase()==='a'?'a':'b';
const EXEC=(mode==='a')?EXEC_A:EXEC_B;
const problem=qs.get('problem')||'';
let tk=(qs.get('tk')||localStorage.getItem('tk')||localStorage.getItem('teacherKey')||'').trim();
if(qs.get('tk')){ localStorage.setItem('tk',tk); localStorage.setItem('teacherKey',tk); }
localStorage.setItem('mode',mode);

const $=id=>document.getElementById(id);
const splash=$('splash'), camBox=$('camBox'), video=$('v'),
      whoBox=$('whoBox'), grid=$('nameGrid'), noteNames=$('noteNames'),
      btnStart=$('btnStart'), btnShoot=$('btnShoot'),
      btnPick=$('btnPick'), filePick=$('filePick');
let stream=null, roster=[], selected='';

function jsonp(url, timeout=15000){
  return new Promise((res,rej)=>{
    const cb='cb_'+Math.random().toString(36).slice(2); let done=false;
    const t=setTimeout(()=>{ if(done)return; done=true; cleanup(); rej(new Error('timeout')); }, timeout);
    function cleanup(){ try{ delete window[cb]; s.remove(); }catch(_){ } clearTimeout(t); }
    window[cb]=d=>{ if(done)return; done=true; cleanup(); res(d); };
    const s=document.createElement('script');
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb; s.onerror=()=>{ if(done)return; done=true; cleanup(); rej(new Error('network')); };
    document.body.appendChild(s);
  });
}

// ì—…ë¡œë“œ ë°˜ì˜ í™•ì¸: ì—…ë¡œë“œ ì§í›„ ì‹œê° ì´í›„ì˜ ë ˆì½”ë“œê°€ ë³´ì´ëŠ”ì§€
async function waitServerWrite(t0, tries=3){
  for(let i=0;i<tries;i++){
    await new Promise(r=>setTimeout(r, 800));
    try{
      const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'listByChild', key: tk}));
      const items = (r && Array.isArray(r.items)) ? r.items : [];
      if(items.some(it => Number(it.ts||0) >= (t0-3000))) return true;
    }catch(_){}
  }
  return false;
}

// ì´ˆê¸°í™”
(async()=>{
  if(!problem){ alert('ë¬¸í•­ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. URLì— ?problem=... ì„ ë¶™ì—¬ ì£¼ì„¸ìš”.'); return; }
  if(!tk){ alert('í•™ê¸‰ ì—°ê²° ì •ë³´(tk)ê°€ ì—†ìŠµë‹ˆë‹¤.\ní™ˆì—ì„œ ë¨¼ì € ë¡œê·¸ì¸(ì—°ê²°)í•˜ê±°ë‚˜, ë§í¬ì— &tk=í•™ê¸‰í‚¤ ë¥¼ ë¶™ì—¬ ì£¼ì„¸ìš”.'); return; }
  try{
    const j=await jsonp(EXEC+'?'+new URLSearchParams({action:'resolveKey',key:tk}));
    roster=(j&&Array.isArray(j.roster))?j.roster:[];
  }catch(_){}
  renderNames();
  setTimeout(()=>{ startCam().catch(()=>{}); }, 1000); // ìŠ¤í”Œë˜ì‹œ 1ì´ˆ í›„ ì¹´ë©”ë¼
})();

function renderNames(){
  grid.innerHTML='';
  if((roster||[]).length>0){
    whoBox.style.display='block'; noteNames.style.display='block';
    roster.forEach(n=>{
      const b=document.createElement('button');
      b.type='button'; b.className='nameBtn'+(selected===n?' sel':''); b.textContent=n;
      b.onclick=()=>{ selected=n; renderNames(); };
      grid.appendChild(b);
    });
  }else{
    whoBox.style.display='none'; noteNames.style.display='none';
  }
}

async function startCam(){
  stopCam();
  splash.style.display='none';
  camBox.style.display='flex';

  let constraints={audio:false, video:{facingMode:{ideal:'user'}, width:{ideal:1280}, height:{ideal:720}}};
  try{
    stream=await navigator.mediaDevices.getUserMedia(constraints);
    const isFront = await seemsFront(stream);
    if(!isFront){
      stopCam();
      const devId = await findFrontDeviceId();
      if(devId){
        stream=await navigator.mediaDevices.getUserMedia({audio:false, video:{deviceId:{exact:devId}, width:{ideal:1280}, height:{ideal:720}}});
      }else{
        stream=await navigator.mediaDevices.getUserMedia({audio:false, video:{facingMode:{exact:'user'}}});
      }
    }
    video.srcObject=stream; await video.play();
  }catch(e){
    btnPick.style.display='inline-block'; filePick.style.display='none';
    alert('ì „ë©´ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”. ì•ˆ ë  ê²½ìš° "ì‚¬ì§„ ì„ íƒ(í´ë°±)"ì„ ì‚¬ìš©í•˜ì„¸ìš”.');
  }
}
function stopCam(){ try{ stream && stream.getTracks().forEach(t=>t.stop()); }catch(_){} stream=null; }
document.getElementById('btnStart').onclick = ()=>startCam();

async function seemsFront(strm){
  try{
    const s = strm.getVideoTracks()[0].getSettings();
    if(s && s.facingMode) return (''+s.facingMode).toLowerCase().includes('user');
  }catch(_){}
  return false;
}
async function findFrontDeviceId(){
  try{
    const list = await navigator.mediaDevices.enumerateDevices();
    const cams = list.filter(d=>d.kind==='videoinput');
    const cand = cams.find(c=>/front|ì „ë©´|user/i.test(c.label)) || cams[0];
    return cand && cand.deviceId;
  }catch(_){ return null; }
}

document.getElementById('btnShoot').onclick=async ()=>{
  try{
    let dataURL=null, mime='image/jpeg', filename='capture.jpg';
    if(stream){
      const cv=document.createElement('canvas'), vw=video.videoWidth, vh=video.videoHeight;
      cv.width=vw; cv.height=vh; cv.getContext('2d').drawImage(video,0,0,vw,vh);
      dataURL=cv.toDataURL('image/jpeg',0.92);
    }else{ document.getElementById('btnPick').click(); return; }

    const child = (selected || ''); // ë¯¸ì„ íƒ=ë¯¸ë¶„ë¥˜
    const t0 = Date.now();
    await uploadBase64(dataURL,mime,filename,child);

    const ok = await waitServerWrite(t0, 3);
    if(!ok){
      alert('ì„œë²„ ë°˜ì˜ì„ í™•ì¸í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\nâ‘  ìº¡ì³ì™€ ëŒ€ì‹œë³´ë“œì˜ ëª¨ë“œ(A/B)Â·URL ë™ì¼ ì—¬ë¶€\nâ‘¡ ê°™ì€ ë¸Œë¼ìš°ì €ì— TK ì €ì¥ ì—¬ë¶€ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.');
      return;
    }
    stopCam(); document.getElementById('done').style.display='flex';
  }catch(e){ alert('ì—…ë¡œë“œ ì‹¤íŒ¨'); console.error(e); }
};

document.getElementById('btnPick').onclick = ()=>filePick.click();
filePick.onchange = async ()=>{
  if(!filePick.files.length) return;
  const f=filePick.files[0], mime=f.type||'image/jpeg', filename=f.name||('capture_'+Date.now()+'.jpg');
  const dataURL=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
  const t0=Date.now();
  await uploadBase64(dataURL,mime,filename,'');
  const ok = await waitServerWrite(t0,3);
  if(!ok){ alert('ì„œë²„ ë°˜ì˜ í™•ì¸ ì‹¤íŒ¨(í´ë°± ì—…ë¡œë“œ). ëª¨ë“œ/URL/TKë¥¼ í™•ì¸í•˜ì„¸ìš”.'); return; }
  document.getElementById('done').style.display='flex';
};

async function uploadBase64(dataURL,mime,filename,child){
  const fd=new FormData();
  fd.append('action','uploadSuccess'); fd.append('key',tk); fd.append('problem',problem); fd.append('child',child);
  fd.append('ts',Date.now()); fd.append('file_b64',(dataURL||'').split(',')[1]||''); fd.append('mime',mime); fd.append('filename',filename);
  await fetch(EXEC,{method:'POST',body:fd,mode:'no-cors'}); // CORS ì´ìŠˆ íšŒí”¼
}
</script>
</body>
</html>
