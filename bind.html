<!doctype html><html lang="ko"><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>앱 연결</title>
<style>
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;background:#eaf6ff;color:#0f172a}
.wrap{max-width:680px;margin:0 auto;padding:24px}
.card{background:#fff;border:1px solid #cbd5e1;border-radius:16px;padding:20px}
h1{margin:0 0 10px} .ok{color:#16a34a;font-weight:800}
.btn{display:inline-block;margin-top:12px;padding:10px 16px;border:0;border-radius:12px;background:#0ea5e9;color:#fff;font-weight:800;text-decoration:none}
.note{font-size:12px;color:#334155;margin-top:8px}
.list{margin-top:14px;display:grid;gap:8px}
a.link{display:block;background:#0f172a;color:#fff;padding:10px 12px;border-radius:10px;text-decoration:none}
</style>
<body>
<script>
/* EXEC Glue v1 — 모든 페이지에서 동일 EXEC 유지 */
(function () {
  const q = new URLSearchParams(location.search);
  const paramExec = q.get('exec');
  const savedExec = localStorage.getItem('EXEC');
  const DEFAULT_EXEC = ''; // (선택) 비워두고, 첫 진입은 반드시 ?exec=... 로 들어오게 함

  // 1) 결정
  const EXEC = (paramExec && paramExec.trim()) || savedExec || DEFAULT_EXEC;
  if (!EXEC) {
    console.warn('[EXEC] not set. Append ?exec=<teacher-exec> to URL once.');
  }
  // 2) 저장
  if (EXEC && EXEC !== savedExec) localStorage.setItem('EXEC', EXEC);
  // 3) 전역 노출
  window.EXEC = EXEC;

  // 4) 내부 페이지 이동(a[href$=".html"])에 exec 자동 부착
  document.addEventListener('DOMContentLoaded', () => {
    if (!EXEC) return;
    document.querySelectorAll('a[href$=".html"]').forEach(a => {
      const u = new URL(a.getAttribute('href'), location.href);
      if (!u.searchParams.get('exec')) {
        u.searchParams.set('exec', EXEC);
        a.setAttribute('href', u.pathname + u.search);
      }
    });
  });
})();
</script>

<div class="wrap"><div class="card">
  <h1>앱에 학급 연결</h1>
  <div id="msg">처리 중…</div>
  <div class="note">이 페이지를 <b>스마트메이커(앱)</b> 안에서 한 번만 열어 주세요.</div>
  <div id="links" class="list" style="display:none"></div>
</div></div>
<script>
const qs=new URLSearchParams(location.search);
const tk=(qs.get('tk')||'').trim();
const mode=(qs.get('mode')||'b').toLowerCase()==='a'?'a':'b';
if(tk){
  localStorage.setItem('tk', tk);
  localStorage.setItem('teacherKey', tk);
  localStorage.setItem('mode', mode);
  document.getElementById('msg').innerHTML = '<span class="ok">연결 완료!</span> 이제 이 앱에서 캡쳐를 열면 손님모드가 아닙니다.';
  // 바로 사용 링크
  const P=[
   ['02_위험찾기','02 위험찾기'],
   ['03_화재대피안전수칙','03 화재대피안전수칙'],
   ['04_비상구로대피','04 비상구로대피'],
   ['05_옷에불이붙었어요','05 옷에불이붙었어요'],
   ['06_119신고하기','06 119신고하기'],
   ['07_소화기사용법','07 소화기사용법'],
   ['08_완강기사용법','08 완강기사용법'],
  ];
  const base = location.origin + location.pathname.replace(/\/bind\.html$/,'/capture.html');
  const box=document.getElementById('links'); box.style.display='grid'; box.innerHTML='';
  P.forEach(([key,label])=>{
    const a=document.createElement('a');
    a.href = `${base}?problem=${encodeURIComponent(key)}&mode=${mode}&tk=${encodeURIComponent(tk)}`;
    a.textContent = `캡쳐 열기 · ${label}`;
    a.className='link'; box.appendChild(a);
  });
}else{
  document.getElementById('msg').textContent='tk가 없습니다. 교사용 홈에서 생성된 링크로 들어오세요.';
}
</script>
