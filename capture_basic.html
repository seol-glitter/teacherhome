<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>캡쳐(웹뷰용)</title>
<style>
:root{--bg1:#dff0ff;--bg2:#eaf6ff;--ink:#0f172a;--ok:#16a34a;--btn:#0ea5e9;--btnD:#0284c7}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;color:var(--ink);
  background:linear-gradient(180deg,var(--bg1),var(--bg2))}
.wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px}
.card{width:min(1100px,96vw);background:#fff;border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:18px}
h1{margin:4px 0 12px;font-size:clamp(20px,4.8vw,28px)}
.note{font-size:12px;color:#334155;margin:-6px 0 10px}
.who{max-height:28vh;overflow:auto;border:1px solid #cbd5e1;border-radius:12px;padding:10px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.name{padding:12px;border:1px solid #94a3b8;border-radius:12px;background:#f8fafc;font-weight:800;text-align:center;cursor:pointer}
.name.sel{outline:3px solid #0ea5e9;border-color:#0ea5e9;background:#e0f2fe}
.actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:12px}
.btn{padding:12px 16px;border:0;border-radius:12px;color:#fff;background:var(--btn);font-weight:900;cursor:pointer}
.btn:hover{background:var(--btnD)}
.shutter{width:min(18vw,110px);height:min(18vw,110px);min-width:84px;min-height:84px;border-radius:999px;border:none;background:var(--ok);
  display:inline-flex;align-items:center;justify-content:center;box-shadow:0 10px 24px rgba(0,0,0,.25)}
.shutter svg{width:55%;height:55%;fill:#fff}
#preview{display:none;margin-top:12px;max-width:100%;border-radius:12px}
.ok{display:none;margin-top:10px;color:#16a34a;font-weight:700}
</style>
<body>
<script>
/* EXEC Glue v1 — 모든 페이지에서 동일 EXEC 유지 */
(function () {
  const q = new URLSearchParams(location.search);
  const paramExec = q.get('exec');
  const savedExec = localStorage.getItem('EXEC');
  const DEFAULT_EXEC = ''; // (선택) 비워두고, 첫 진입은 반드시 ?exec=... 로 들어오게 함

  // 1) 결정
  const EXEC = (paramExec && paramExec.trim()) || savedExec || DEFAULT_EXEC;
  if (!EXEC) {
    console.warn('[EXEC] not set. Append ?exec=<teacher-exec> to URL once.');
  }
  // 2) 저장
  if (EXEC && EXEC !== savedExec) localStorage.setItem('EXEC', EXEC);
  // 3) 전역 노출
  window.EXEC = EXEC;

  // 4) 내부 페이지 이동(a[href$=".html"])에 exec 자동 부착
  document.addEventListener('DOMContentLoaded', () => {
    if (!EXEC) return;
    document.querySelectorAll('a[href$=".html"]').forEach(a => {
      const u = new URL(a.getAttribute('href'), location.href);
      if (!u.searchParams.get('exec')) {
        u.searchParams.set('exec', EXEC);
        a.setAttribute('href', u.pathname + u.search);
      }
    });
  });
})();
</script>

<div class="wrap"><div class="card">
  <h1>사진 촬영</h1>
  <div class="note">* 기본 선택은 <b id="klassName">(학급명)</b> 입니다. 그대로 촬영하면 <b>미분류</b>로 올라가며, 교사가 대시보드에서 분류할 수 있습니다.</div>

  <div class="who"><div id="grid" class="grid"></div></div>

  <div class="actions">
    <!-- 카메라 앱 호출 -->
    <input id="file" type="file" accept="image/*" capture="user" style="display:none">
    <button class="shutter" id="btnShoot" aria-label="촬영">
      <svg viewBox="0 0 24 24"><path d="M9.5 5h5l1.3 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h4.2L9.5 5zm2.5 12a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9z"/></svg>
    </button>
    <button class="btn" id="btnPick">사진 선택</button>
    <span id="hint" class="note"></span>
  </div>

  <img id="preview" alt="미리보기">
  <div id="ok" class="ok">업로드 성공! 잠시 후 앱으로 돌아갑니다…</div>
</div></div>

<!-- 얼굴 임베딩 -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script>
const EXEC_A="https://script.google.com/macros/s/AKfycby4camh7UDnlV4ElL3eJPUUWvslSAtfyssAQBRfizcY9D1MRJK9r_O0ZYDnQvKryalG/exec";
const EXEC_B="https://script.google.com/macros/s/AKfycbzNUWjOhh3V-Cu2WYkl6voDKoAHFKjOl_OQbKH6rQYj6o8K06YoQmc0D7Q6WMJJ-Foz/exec";
const qs=new URLSearchParams(location.search);
const mode=(qs.get('mode')||localStorage.getItem('mode')||'b').toLowerCase()==='a'?'a':'b';
const EXEC=(mode==='a')?EXEC_A:EXEC_B;
const problem=qs.get('problem')||'';
let tk=(qs.get('tk')||localStorage.getItem('tk')||localStorage.getItem('teacherKey')||'').trim();
if(qs.get('tk')){ localStorage.setItem('tk',tk); localStorage.setItem('teacherKey',tk); }
localStorage.setItem('mode',mode);

const $=id=>document.getElementById(id), grid=$('grid'); let klass='', roster=[], selected='';
function jsonp(url,timeout=15000){return new Promise((res,rej)=>{const cb='cb_'+Math.random().toString(36).slice(2);let done=false;
  const t=setTimeout(()=>{if(done)return;done=true;cleanup();rej(new Error('timeout'));},timeout);
  function cleanup(){try{delete window[cb];s.remove();}catch(_){ }clearTimeout(t);}
  window[cb]=d=>{if(done)return;done=true;cleanup();res(d);};
  const s=document.createElement('script'); s.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
  s.onerror=()=>{if(done)return;done=true;cleanup();rej(new Error('network'));}; document.body.appendChild(s);});}

(async()=>{ // 학급/명단 불러와 버튼 생성
  try{
    if(tk){
      const j=await jsonp(EXEC+'?'+new URLSearchParams({action:'resolveKey',key:tk}));
      roster=(j&&Array.isArray(j.roster))?j.roster:[]; klass=(j&&j.classId)||'';
    }
  }catch(_){}
  $('klassName').textContent=klass||'(학급)';
  renderNames();
})();

function renderNames(){
  grid.innerHTML='';
  const add=(name,isClass=false)=>{ const b=document.createElement('button');
    b.type='button'; b.className='name'+(selected===name?' sel':''); b.textContent=isClass?`${name} (기본)`:name;
    b.onclick=()=>{selected=name;renderNames();}; grid.appendChild(b); };
  if(klass){ add(klass,true); if(!selected) selected=klass; }
  (roster||[]).forEach(n=>{ if(n&&n!==klass) add(n,false);});
}

/* ---- 얼굴 임베딩: 파일에서도 계산 ---- */
const FACEAPI_MODELS='https://justadudewhohacks.github.io/face-api.js/models';
let modelsReady=false;
Promise.all([
  faceapi.nets.tinyFaceDetector.loadFromUri(FACEAPI_MODELS),
  faceapi.nets.faceLandmark68Net.loadFromUri(FACEAPI_MODELS),
  faceapi.nets.faceRecognitionNet.loadFromUri(FACEAPI_MODELS),
]).then(()=>{modelsReady=true; $('hint').textContent='자동분류 준비 완료(처음 1~2회 이름 지정 후 자동분류).';})
 .catch(()=>{$('hint').textContent='자동분류 준비 실패(네트워크). 수동 선택으로 이용하세요.';});

const THRESH=0.83;
function dbKey(){ return 'faceDB::'+(tk||''); }
function loadDB(){ try{ return JSON.parse(localStorage.getItem(dbKey())||'{}'); }catch(_){ return {}; } }
function saveDB(db){ localStorage.setItem(dbKey(), JSON.stringify(db)); }
function cos(a,b){ let dot=0,na=0,nb=0; const n=Math.min(a.length,b.length);
  for(let i=0;i<n;i++){ dot+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i]; } return dot/(Math.sqrt(na)*Math.sqrt(nb)+1e-9); }
function ema(oldV,newV,a=0.85){ const n=Math.min(oldV.length,newV.length),o=new Array(n); for(let i=0;i<n;i++) o[i]=a*oldV[i]+(1-a)*newV[i]; return o; }
function updateCentroid(child,desc){ if(!child||!desc) return; const db=loadDB(),cur=db[child];
  if(cur && Array.isArray(cur.vec)) db[child]={vec:ema(cur.vec,desc,0.85),n:(cur.n||1)+1}; else db[child]={vec:Array.from(desc),n:1}; saveDB(db); }
function predict(desc){ const db=loadDB(); let best='',score=-1; for(const n in db){ const s=cos(db[n].vec,desc); if(s>score){score=s;best=n;} }
  return (best && score>=THRESH)?{child:best,score}:null; }

/* ---- 파일 선택 → 미리보기 → 임베딩/업로드 ---- */
const file=$('file'), preview=$('preview'), ok=$('ok');
$('btnShoot').onclick=()=>file.click(); $('btnPick').onclick=()=>file.click();

file.onchange=async()=>{
  if(!file.files.length) return;
  const f=file.files[0]; const url=URL.createObjectURL(f);
  preview.src=url; preview.style.display='block';

  // 이미지에서 descriptor 추출
  let desc=null, embedCSV='', child=selected||klass||'';
  try{
    if(modelsReady){
      const img=await faceapi.bufferToImage(f);
      const det=await faceapi.detectSingleFace(img,new faceapi.TinyFaceDetectorOptions({inputSize:320,scoreThreshold:0.5}))
              .withFaceLandmarks().withFaceDescriptor();
      if(det && det.descriptor){ desc=Array.from(det.descriptor); }
      if(desc){
        const guess=predict(desc);
        if(guess && (!child || child===klass)){ child=guess.child; $('hint').textContent=`자동선택: ${child} (신뢰 ${guess.score.toFixed(2)})`; }
        if(child && child!==klass) updateCentroid(child,desc);
        embedCSV=desc.join(',');
      }
    }
  }catch(_){}

  if(child===klass) child=''; // 기본=학급명 → 미분류

  // base64 변환
  const dataURL=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
  await uploadBase64(dataURL,f.type||'image/jpeg',f.name||('capture_'+Date.now()+'.jpg'),child,embedCSV);

  ok.style.display='block';
  // 내부 웹뷰 복귀: done.html#close 로 이동 (앱 업무규칙에서 이 URL 감지 → 웹뷰 닫기)
  location.href = 'https://seol-glitter.github.io/teacherhome/done.html#close';
};

async function uploadBase64(dataURL,mime,filename,child,embedCSV){
  const fd=new FormData();
  fd.append('action','uploadSuccess'); fd.append('key',tk); fd.append('problem',problem); fd.append('child',child);
  fd.append('ts',Date.now()); fd.append('file_b64',(dataURL||'').split(',')[1]||''); fd.append('mime',mime); fd.append('filename',filename);
  if(mode==='a' && embedCSV) fd.append('embed_csv',embedCSV);
  await fetch(EXEC,{method:'POST',body:fd,mode:'no-cors'});
}
</script>
</body>
</html>
