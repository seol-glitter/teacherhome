<!doctype html>
<html lang="ko">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>교사용 홈화면</title>
<style>
:root{
  --bg1:#dff0ff; --bg2:#eaf6ff; --ink:#0f172a;
  --card:#ffffff; --line:#d7e7f5;
  --primary:#0ea5e9; --primaryD:#0284c7;
  --success:#22c55e; --danger:#ef4444; --muted:#64748b;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;color:var(--ink);
     background:linear-gradient(180deg,var(--bg1),var(--bg2))}
.wrap{max-width:1120px;margin:24px auto;padding:0 16px}

/* 배너 */
.banner{background:#e7f3ff;border:1px solid var(--line);border-radius:18px;overflow:hidden;margin-bottom:16px}
.banner img{display:block;width:100%;height:auto}

/* 카드 */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:0}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
.card h3{margin:0 0 10px 0;font-size:18px}
.row{display:flex;gap:8px;align-items:center;margin:8px 0}
.row label{min-width:88px;font-size:14px;color:#334155}
.row input{flex:1;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:16px}
.btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer}
.btn-primary{background:var(--primary);color:white}
.btn-primary:hover{background:var(--primaryD)}
.btn-ghost{background:#f1f5f9;color:#0f172a;border:1px solid #e2e8f0}
.btn-danger{background:var(--danger);color:white}
.small{font-size:13px;color:var(--muted)}
.msg{margin-top:8px;color:#0f172a;font-size:14px;min-height:20px}
.footer{margin:18px 0 8px;text-align:center;color:#64748b;font-size:12px}
.kit{display:inline-flex;gap:6px;flex-wrap:wrap}
.kit a{display:inline-block;padding:8px 10px;border-radius:10px;background:#eef6ff;border:1px solid var(--line);text-decoration:none;color:#0f172a}

/* --- PATCH: 버튼 색상 보완 (디자인 유지, 은은한 톤) --- */
#linkClass{
  background:#E8F7EE;       /* 초록 파스텔 */
  border-color:#A7E5BF;
  color:#166534;
}
#linkClass:hover{ background:#DAF1E2; }

#joinBtn{                 /* 학급 생성: 소프트 블루 */
  background:#F1F5FF;
  border:1px solid #BFDBFE;
  color:#1D4ED8;
}

#btnCheck{                /* 상태 확인중 → 카메라 점검 */
  background:#FEF9C3;     /* 소프트 옐로 */
  border:1px solid #FDE68A;
  color:#92400E;
}
#openCaptureBasic{        /* 카메라 권한 요청하기 */
  background:#F0F9FF;     /* 소프트 스카이 */
  border:1px solid #BAE6FD;
  color:#075985;
}
#openSettings{            /* 설정 여는 방법 */
  background:#F5F3FF;     /* 소프트 퍼플 */
  border:1px solid #DDD6FE;
  color:#4C1D95;
}

</style>

<body>
<div class="wrap">
  <div class="banner"><img id="bannerImg" src="" alt="안전교육 도구 교사용 배너"></div>

  <div class="grid">
    <div class="card">
      <h3>교사용 홈 <span class="small">손님</span></h3>
      <div class="row"><label>기관명</label><input id="school" placeholder="예) ○○유치원"></div>
      <div class="row"><label>학급명</label><input id="klass"  placeholder="예) ○○반"></div>
      <div class="row"><label>비밀번호</label><input id="tcode" type="password" placeholder="예) 4자리 이상"></div>

      <div class="row" style="gap:10px">
        <button id="goDashboardBtn" class="btn btn-primary" style="flex:1">나의 학급 들어가기</button>
        <button id="joinBtn" class="btn btn-ghost" style="flex:1">학급 생성</button>
      </div>

      <div class="row"><button id="unbindBtn" class="btn btn-danger" style="width:100%">기기 연결 해제</button></div>
      <div class="small">※ 기기 연결 해제 버튼을 누르면 이 기기에 저장된 정보가 삭제되어 손님모드로 전환됩니다. (서버의 학급·기록은 보존)</div>
      <div id="msg" class="msg"></div>
    </div>

    <div class="card">
      <h3>수업하기</h3>
      <div class="kit"><a id="linkClass" href="https://sites.google.com/view/safetyedu" target="_blank" rel="noopener">수업하기 (가입 없이 바로 사용)</a></div>
      <h3 style="margin-top:18px">안내</h3>
      <ul class="small">
        <li>‘수업하기’는 가입 없이 대집단 수업에 바로 활용할 수 있습니다.</li>
        <li>‘학급 생성’으로 학급 유아의 성취 상황을 기록할 수 있습니다.</li>
        <li>‘나의 학급 들어가기’에서 학급 유아의 성취 상황을 확인할 수 있습니다.</li>
        <li>같은 기관·반 이름이라도 비밀번호가 다르면 서로 다른 독립 학급으로 인식됩니다.</li>
        <li>수집된 자료는 가입일로부터 18개월 후 자동 삭제됩니다.</li>
      </ul>

      <h3 style="margin-top:18px">카메라 준비/점검</h3>
      <div class="row">
        <button id="btnCheck" class="btn btn-ghost">상태 확인 중…</button>
        <a class="btn btn-ghost" href="#" id="openCaptureBasic">카메라 권한 요청하기</a>
        <a class="btn btn-ghost" href="#" id="openSettings">설정 여는 방법</a>
      </div>
    </div>
  </div>

  <div class="footer">build:index-bind-strict v2</div>
</div>

<script>
/* ---------- 경로/상수 ---------- */
const BASE = location.origin + location.pathname.replace(/[^/]+$/, ''); // 현재 폴더 경로
const path = (name)=> BASE + name;
const DASH = ()=> path('dashboard.html');
const $ = id=> document.getElementById(id);

// 배너/링크 절대경로 세팅(상대경로 이슈 방지)
$('bannerImg').src = path('banner.png');
document.getElementById('openCaptureBasic').setAttribute('href', path('capture_basic.html'));

/* ---------- 상태/EXEC ---------- */
const EXEC = (localStorage.getItem('EXEC') || '').trim() || 'https://script.google.com/macros/s/AKfycbx.../exec'; // 실제 배포 주소로 유지
function drawState(){
  const tk = (localStorage.getItem('tk')||sessionStorage.getItem('tk')||'').trim();
  document.querySelector('.small').textContent = tk? '연결됨' : '손님';
}

/* ---------- JSONP ---------- */
function jsonp(url){
  return new Promise((resolve)=>{
    const cb='cb'+Math.random().toString(36).slice(2);
    const s=document.createElement('script');
    const u = url + (url.includes('?')?'&':'?') + 'callback='+cb;
    window[cb]=function(data){ try{ delete window[cb]; }catch(_){ } document.body.removeChild(s); resolve(data); };
    s.src=u; s.onerror=()=>resolve({ok:false,error:'net'}); document.body.appendChild(s);
  });
}

/* ---------- 학급 생성만(createClass) ---------- */
async function createOnly(){
  const s=$('school').value.trim(), k=$('klass').value.trim(), c=$('tcode').value.trim();
  if(!s||!k||!c){ $('msg').textContent='기관명/반 이름/비밀번호를 모두 입력하세요.'; return false; }
  $('msg').textContent='학급 생성 중…';
  try{
    const j = await jsonp(EXEC+'?'+new URLSearchParams({action:'createClass',schoolId:s,classId:k,code:c}));
    if(j&&j.ok&&j.teacherKey){
      localStorage.setItem('tk', j.teacherKey);
      localStorage.setItem('teacherKey', j.teacherKey);
      localStorage.setItem('schoolId', s); localStorage.setItem('classId', k);
      $('msg').textContent='학급이 생성되었습니다. 오른쪽의 "나의 학급 들어가기"를 눌러 주세요.';
      drawState();
      return true;
    }else{
      const err=(j&&j.error)||'server';
      if(err==='exists') $('msg').textContent='이미 존재하는 학급입니다. "나의 학급 들어가기"를 사용하세요.';
      else if(err==='unknown action') $('msg').textContent='서버에 createClass 액션이 없어 생성할 수 없습니다. (서버 업데이트 필요)';
      else $('msg').textContent='생성 실패: '+(err==='auth'?'비밀번호가 일치하지 않습니다.':'서버 응답 오류');
      return false;
    }
  }catch(e){
    $('msg').textContent='네트워크 오류';
    return false;
  }
}

/* ---------- 바인드만(key) ---------- */
async function bindOnly(){
  const s=$('school').value.trim(), k=$('klass').value.trim(), c=$('tcode').value.trim();
  if(!s||!k||!c){ $('msg').textContent='기관명/반 이름/비밀번호를 모두 입력하세요.'; return false; }
  $('msg').textContent='서버 확인 중…';
  try{
    const r = await jsonp(EXEC+'?'+new URLSearchParams({action:'key', schoolId:s, classId:k, code:c}));
    if(r && r.ok && r.teacherKey){
      try{
        localStorage.setItem('tk', r.teacherKey);
        localStorage.setItem('teacherKey', r.teacherKey);
        localStorage.setItem('schoolId', s); localStorage.setItem('classId', k);
      }catch(_){}
      $('msg').textContent='연결되었습니다.';
      drawState();
      return true;
    }else{
      const err=(r&&r.error)||'auth';
      $('msg').textContent=(err==='no class')? '해당 학급이 없습니다. "학급 생성"을 먼저 해 주세요.' : '비밀번호가 일치하지 않습니다.';
      return false;
    }
  }catch(_){
    $('msg').textContent='네트워크 오류';
    return false;
  }
}

/* ---------- 버튼: 학급 관련 ---------- */
$('unbindBtn').onclick = ()=>{
  if(!confirm('이 기기의 연결정보를 삭제하고 손님모드로 전환합니다. 진행할까요?')) return;
  ['tk','teacherKey','schoolId','classId','faceDB'].forEach(k=>{
    try{ localStorage.removeItem(k); sessionStorage.removeItem(k);}catch(_){}
  });
  $('msg').textContent='이 기기의 저장정보가 삭제되었습니다.';
  drawState();
};

// 학급 생성(정말 생성만)
$('joinBtn').onclick = createOnly;

// 나의 학급 들어가기: 과거 TK를 삭제하고 현재 입력으로 반드시 재바인딩(검증) 후 이동
$('goDashboardBtn').onclick = async ()=>{
  try{
    localStorage.removeItem('tk'); localStorage.removeItem('teacherKey');
    sessionStorage.removeItem('tk'); sessionStorage.removeItem('teacherKey');
  }catch(_){}
  const ok = await bindOnly();   // 입력값 검증(비번/존재 확인)
  if(!ok) return;                // 실패 시 이동 금지
  location.href = DASH();
};

/* ---------- 부가: 카메라 권한 버튼 ---------- */
$('btnCheck').onclick = ()=>{ $('btnCheck').textContent='카메라 점검'; };
$('openSettings').onclick = (e)=>{ e.preventDefault(); alert('브라우저 설정에서 카메라 권한을 허용해 주세요.'); };

drawState();
</script>
<script>
// === 최소 패치: 경로 수리, 버튼 동작 재지정, 카메라 점검 개선 ===

// 0) 유틸
const $$ = (id)=> document.getElementById(id);
function basePath(name){ return new URL(name, location.href).href; }

// 1) 링크 고정 (수업하기 / 카메라 권한요청)
try {
  if ($$('linkClass')) $$('linkClass').setAttribute('href', 'https://sites.google.com/view/safetyedu');
  if ($$('openCaptureBasic')) $$('openCaptureBasic').setAttribute('href', basePath('capture_basic.html'));
} catch(_) {}

// 2) JSONP 헬퍼 (없으면 정의)
if(typeof jsonp!=='function'){
  window.jsonp = (url)=> new Promise((resolve)=>{
    const cb = 'cb'+Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    const u = url + (url.includes('?')?'&':'?') + 'callback='+cb;
    window[cb] = (d)=>{ try{ delete window[cb]; }catch(_){ } document.body.removeChild(s); resolve(d); };
    s.src = u; s.onerror=()=> resolve({ok:false,error:'net'}); document.body.appendChild(s);
  });
}

// 3) EXEC 상수 추출 (기존 전역 EXEC가 있으면 그대로 사용)
const EXEC_URL = (typeof EXEC==='string' && EXEC) ? EXEC : (localStorage.getItem('EXEC')||'').trim();

// 4) 바인드/생성 함수 (서버: multicode 버전 전제)
async function bindOnlyV3(){
  const s=($$('school')?.value||'').trim(), k=($$('klass')?.value||'').trim(), c=($$('tcode')?.value||'').trim();
  if(!s||!k||!c){ $$('msg') && ($$('msg').textContent='기관명/학급명/비밀번호를 모두 입력하세요.'); return false; }
  $$('msg') && ($$('msg').textContent='서버 확인 중…');
  const r = await jsonp(EXEC_URL+'?'+new URLSearchParams({action:'key',schoolId:s,classId:k,code:c}));
  if(r && r.ok && r.teacherKey){
    try{
      localStorage.setItem('tk', r.teacherKey);
      localStorage.setItem('teacherKey', r.teacherKey);
      localStorage.setItem('schoolId', s); localStorage.setItem('classId', k);
    }catch(_){}
    $$('msg') && ($$('msg').textContent='연결되었습니다.');
    return true;
  }else{
    $$('msg') && ($$('msg').textContent = (r&&r.error)==='no class' ? '해당 학급이 없습니다. 먼저 학급을 생성하세요.' : '비밀번호가 일치하지 않습니다.');
    return false;
  }
}

async function createOnlyV3(){
  const s=($$('school')?.value||'').trim(), k=($$('klass')?.value||'').trim(), c=($$('tcode')?.value||'').trim();
  if(!s||!k||!c){ $$('msg') && ($$('msg').textContent='기관명/학급명/비밀번호를 모두 입력하세요.'); return false; }
  $$('msg') && ($$('msg').textContent='학급 생성 중…');
  const j = await jsonp(EXEC_URL+'?'+new URLSearchParams({action:'createClass',schoolId:s,classId:k,code:c}));
  if(j && j.ok && j.teacherKey){
    try{
      localStorage.setItem('tk', j.teacherKey);
      localStorage.setItem('teacherKey', j.teacherKey);
      localStorage.setItem('schoolId', s); localStorage.setItem('classId', k);
    }catch(_){}
    $$('msg') && ($$('msg').textContent='학급이 생성되었습니다. "나의 학급 들어가기"를 누르세요.');
    return true;
  }else{
    $$('msg') && ($$('msg').textContent = (j&&j.error)==='exists' ? '이미 같은 비밀번호의 학급이 있습니다. "나의 학급 들어가기"를 사용하세요.' : '생성 실패: 서버 응답 오류');
    return false;
  }
}

// 5) 버튼 재지정 (기존 UI 유지)
if ($$('joinBtn')) $$('joinBtn').onclick = createOnlyV3;
if ($$('goDashboardBtn')) $$('goDashboardBtn').onclick = async ()=>{
  try{
    localStorage.removeItem('tk'); localStorage.removeItem('teacherKey');
    sessionStorage.removeItem('tk'); sessionStorage.removeItem('teacherKey');
  }catch(_){}
  const ok = await bindOnlyV3();
  if(ok){ location.href = (typeof DASH==='function') ? DASH() : basePath('dashboard.html'); }
};
if ($$('unbindBtn')) $$('unbindBtn').onclick = ()=>{
  if(!confirm('이 기기의 연결정보를 삭제하고 손님모드로 전환합니다. 진행할까요?')) return;
  ['tk','teacherKey','schoolId','classId','faceDB'].forEach(k=>{ try{ localStorage.removeItem(k); sessionStorage.removeItem(k);}catch(_){ } });
  $$('msg') && ($$('msg').textContent='이 기기의 저장정보가 삭제되었습니다.');
};

// 6) 카메라 점검 (실제 getUserMedia 시도)
if ($$('btnCheck')) $$('btnCheck').onclick = async ()=>{
  $$('btnCheck').textContent='카메라 점검';
  if(!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)){
    alert('이 브라우저는 카메라 권한 API를 지원하지 않습니다.');
    return;
  }
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:true});
    // 즉시 정지
    stream.getTracks().forEach(t=>t.stop());
    alert('카메라 접근 성공! (권한 허용됨)');
  }catch(e){
    alert('카메라 접근 실패: 권한이 거부되었거나 장치가 없습니다.\n브라우저 설정에서 카메라 권한을 허용해 주세요.');
  }
};

// 7) "설정 여는 방법" 안내 (기존 텍스트 유지)
if ($$('openSettings')) $$('openSettings').onclick = (e)=>{ e.preventDefault(); alert('브라우저 설정에서 카메라 권한을 허용해 주세요.'); };
</script>
<script>
(function(){
  // 수업하기: WebView에서 새창이 막혀 빈페이지가 뜨는 문제 → 같은 창으로 열기
  const link = document.getElementById('linkClass');
  if (link) {
    link.href = 'https://sites.google.com/view/safetyedu'; // 원래 주소 유지
    link.removeAttribute('target'); // 새창(빈 페이지) 방지
    link.rel = 'noopener';          // 안전 설정
  }
})();
</script>
<script>
(function(){
  const url = 'https://sites.google.com/view/mazerunning/%ED%99%88'; // 게시 URL
  const el = document.getElementById('linkClass');
  if (el) {
    el.href = url;          // 정확한 주소로 고정
    el.removeAttribute('target'); // WebView 새창 문제 방지(같은 창에서 열기)
    el.rel = 'noopener';
  }
})();
</script>

</body>
</html>
