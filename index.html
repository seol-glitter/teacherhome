
<!-- PATCH: build marker & one-time cache-buster -->
<meta name="app-build" content="20250928b">
<script>
(function(){
  var V = '20250928b';
  var meta = document.querySelector('meta[name="app-build"]');
  var isCurrent = !!meta && meta.content === V;
  var url = new URL(location.href);
  var hasParam = (url.searchParams.get('v') === V);
  var seen = false; try { seen = (localStorage.getItem('APP_V') === V); } catch(_){
  }
  if (navigator.onLine && (!isCurrent || !hasParam) && !seen) {
    url.searchParams.set('v', V);
    location.replace(url.toString());
    return;
  }
  try { localStorage.setItem('APP_V', V); } catch(_){
  }
})();
</script>

<style>
/* PATCH: subtle button colors (keep original design) */
#linkClass{
  background:#E8F7EE; border:1px solid #A7E5BF; color:#166534;
}
#linkClass:hover{ background:#DAF1E2; }

#joinBtn{               /* 학급 생성 */
  background:#F1F5FF; border:1px solid #BFDBFE; color:#1D4ED8;
}
#btnCheck{              /* 상태확인중/카메라 점검 */
  background:#FEF9C3; border:1px solid #FDE68A; color:#92400E;
}
#openCaptureBasic{      /* 카메라 권한 요청하기 */
  background:#F0F9FF; border:1px solid #BAE6FD; color:#075985;
}
#openSettings{          /* 설정 여는 방법 */
  background:#F5F3FF; border:1px solid #DDD6FE; color:#4C1D95;
}
</style>
<!doctype html>
<html lang="ko">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>교사용 홈화면</title>
<style>
:root{
  --bg1:#dff0ff; --bg2:#eaf6ff; --ink:#0f172a;
  --card:#ffffff; --line:#d7e7f5;
  --primary:#0ea5e9; --primaryD:#0284c7;
  --success:#22c55e; --danger:#ef4444; --muted:#64748b;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;color:var(--ink);
     background:linear-gradient(180deg,var(--bg1),var(--bg2))}
.wrap{max-width:1120px;margin:24px auto;padding:0 16px}

/* 배너 */
.banner{background:#e7f3ff;border:1px solid var(--line);border-radius:18px;overflow:hidden}
.banner img{display:block;width:100%;height:auto}

/* 카드 */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:16px}
.card{background:var(--card); border:1px solid var(--line); border-radius:18px; padding:16px}
.card h3{margin:0 0 12px}
.row{display:flex;gap:10px;flex-wrap:wrap}
input{width:100%;padding:12px;border-radius:12px;border:1px solid #cbd5e1;background:#fff}
.btn{padding:12px 16px;border-radius:12px;border:0;font-weight:900;color:#fff;cursor:pointer;display:inline-block;text-align:center}
.btn.primary{background:var(--primary)} .btn.primary:hover{background:var(--primaryD)}
.btn.success{background:var(--success)}
.btn.danger{background:var(--danger)}
.btn.muted{background:#334155}
.note{font-size:12px;color:#334155}
.bullets{margin:0;padding-left:18px;color:#334155}
.bullets li{margin:6px 0}
.badge{display:inline-block;margin-left:8px;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px}
.badge.on{background:#dcfce7;color:#065f46}
.badge.off{background:#fee2e2;color:#991b1b}
@media (max-width:900px){ .grid{grid-template-columns:1fr} }
</style>
<body>
<script>
/* EXEC Glue v1 — 모든 페이지에서 동일 EXEC 유지 */
(function () {
  const q = new URLSearchParams(location.search);
  const paramExec = q.get('exec');
  const savedExec = localStorage.getItem('EXEC');
  const DEFAULT_EXEC = ''; // (선택) 비워두고, 첫 진입은 반드시 ?exec=... 로 들어오게 함

  // 1) 결정
  const EXEC = (paramExec && paramExec.trim()) || savedExec || DEFAULT_EXEC;
  if (!EXEC) {
    console.warn('[EXEC] not set. Append ?exec=<teacher-exec> to URL once.');
  }
  // 2) 저장
  if (EXEC && EXEC !== savedExec) localStorage.setItem('EXEC', EXEC);
  // 3) 전역 노출
  window.EXEC = EXEC;

  // 4) 내부 페이지 이동(a[href$=".html"])에 exec 자동 부착
  document.addEventListener('DOMContentLoaded', () => {
    if (!EXEC) return;
    document.querySelectorAll('a[href$=".html"]').forEach(a => {
      const u = new URL(a.getAttribute('href'), location.href);
      if (!u.searchParams.get('exec')) {
        u.searchParams.set('exec', EXEC);
        a.setAttribute('href', u.pathname + u.search);
      }
    });
  });
})();
</script>

<div class="wrap">

  <!-- 배너 (루트의 banner.png 사용) -->
  <div class="banner">
    <img id="bannerImg" alt="불의 마법을 푸는 안전 열쇠">
  </div>

  <div style="margin:12px 0 0 4px;font-weight:800">
    교사용 홈 <span id="bindState" class="badge off">손님</span>
  </div>

  <div class="grid">
    <!-- 좌측: 기관/반 설정 -->
    <div class="card">
      <h3>기관/반 설정</h3>
      <div class="row"><input id="school" placeholder="기관명" /></div>
      <div class="row"><input id="klass"  placeholder="반 이름" /></div>
      <div class="row"><input id="tcode"  type="password" placeholder="교사용 비밀번호  (예: RAINBOW-2025)" /></div>
      <div class="row">
        <button class="btn primary" id="goDashboardBtn">나의 학급 들어가기</button>
        <button class="btn muted"   id="joinBtn">학급 생성</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn danger" id="unbindBtn" title="이 기기의 연결정보 삭제">기기 연결 해제</button>
      </div>
      <div class="note" style="margin-top:4px">
        ※ <b>기기 연결 해제</b> 버튼을 누르면 <b>이 기기에 저장된 정보가 삭제</b>되어 손님모드로 전환됩니다. (서버의 학급·기록은 보존)
      </div>
      <div class="note" id="msg" style="margin-top:10px"></div>
    </div>

    <!-- 우측: 수업하기 패널 -->
    <div class="card">
      <h3>수업하기</h3>
      <div class="row">
        <!-- 구글 사이트로 이동(앵커) -->
        <a class="btn success" id="lessonBtn"
           href="https://sites.google.com/view/mazerunning/%ED%99%88"
           target="_self" rel="noopener">수업하기 (가입 없이 바로 사용)</a>
      </div>
      <div class="note" style="margin-top:8px">안내</div>
      <ul class="bullets">
        <li>‘수업하기’는 가입 없이 대집단 수업에 바로 활용할 수 있습니다.</li>
        <li>‘학급 생성’으로 학급 유아의 성취 상황을 기록할 수 있습니다.</li>
        <li>‘나의 학급 들어가기’에서 학급 유아의 성취 상황을 확인할 수 있습니다.</li>
        <li>같은 기관·반 이름이라도 <b>비밀번호가 다르면</b> 서로 다른 독립 학급으로 인식됩니다.</li>
        <li>수집된 자료는 가입일로부터 18개월 후 자동 삭제됩니다.</li>
      </ul>
    </div>

    <!-- (신규) 카메라 준비/점검 -->
    <div class="card">
      <h3>카메라 준비/점검</h3>
      <div class="note" id="camStatus">상태 확인 중…</div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="btnReqCam">카메라 권한 요청하기</button>
        <button class="btn muted" id="btnOpenHelp" type="button">설정 여는 방법</button>
      </div>
      <div class="note" id="camHelp" style="margin-top:8px;display:none"></div>
    </div>
  </div>
</div>

<script>
/* ---------- 배너 경로(루트의 banner.png) ---------- */
(function(){
  const segs = location.pathname.split('/').filter(Boolean);
  const base = segs.length ? '/' + segs[0] : '';
  document.getElementById('bannerImg').src = base + '/banner.png';
})();

/* ---------- 설정 ---------- */
const EXEC_A="https://script.google.com/macros/s/AKfycby4camh7UDnlV4ElL3eJPUUWvslSAtfyssAQBRfizcY9D1MRJK9r_O0ZYDnQvKryalG/exec";
const EXEC_B="https://script.google.com/macros/s/AKfycbzNUWjOhh3V-Cu2WYkl6voDKoAHFKjOl_OQbKH6rQYj6o8K06YoQmc0D7Q6WMJJ-Foz/exec";

const qs=new URLSearchParams(location.search);
const mode=(qs.get('mode')||localStorage.getItem('mode')||'b').toLowerCase()==='a'?'a':'b';
localStorage.setItem('mode', mode);
const EXEC=(mode==='a')?EXEC_A:EXEC_B;

/* ---------- JSONP ---------- */
function jsonp(url, timeout=10000){
  return new Promise((res,rej)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    let done=false;
    const timer=setTimeout(()=>{ if(done) return; done=true; cleanup(); rej(new Error('timeout')); }, timeout);
    function cleanup(){ try{ delete window[cb]; s.remove(); }catch(_){ } clearTimeout(timer); }
    window[cb]=(data)=>{ if(done) return; done=true; cleanup(); res(data); };
    const s=document.createElement('script');
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
    s.onerror=()=>{ if(done) return; done=true; cleanup(); rej(new Error('network')); };
    document.body.appendChild(s);
  });
}

/* ---------- 상태 표시 ---------- */
const $ = (id)=>document.getElementById(id);
function drawState(){
  const on = !!(localStorage.getItem('tk')||localStorage.getItem('teacherKey'));
  const el = $('bindState');
  el.textContent = on ? '연결됨' : '손님';
  el.className = 'badge ' + (on?'on':'off');
}
drawState();

/* ---------- 경로 ---------- */
function repoBase(){ const segs=location.pathname.split('/').filter(Boolean); return segs.length?('/'+segs[0]):''; }
const DASH = () => repoBase() + '/dashboard.html';

/* ---------- 버튼: 학급 관련 ---------- */
$('unbindBtn').onclick = ()=>{
  if(!confirm('이 기기의 연결정보를 삭제하고 손님모드로 전환합니다. 진행할까요?')) return;
  ['tk','teacherKey','schoolId','classId','faceDB'].forEach(k=>localStorage.removeItem(k));
  $('msg').textContent='이 기기의 저장정보가 삭제되었습니다.';
  drawState();
};
$('joinBtn').onclick = bindOnly;
$('goDashboardBtn').onclick = async ()=>{
  const hasTk = !!(localStorage.getItem('tk')||localStorage.getItem('teacherKey'));
  if(!hasTk){ const ok = await bindOnly(); if(!ok) return; }
  location.href = DASH();
};

/* ---------- 로그인(바인딩) ---------- */
async function bindOnly(){
  const s=$('school').value.trim(), k=$('klass').value.trim(), c=$('tcode').value.trim();
  if(!s||!k||!c){ $('msg').textContent='기관명/반 이름/비밀번호를 모두 입력하세요.'; return false; }
  $('msg').textContent='서버 확인 중…';
  try{
    const j = await jsonp(EXEC+'?'+new URLSearchParams({action:'key',schoolId:s,classId:k,code:c}));
    if(j&&j.ok&&j.teacherKey){
      localStorage.setItem('tk', j.teacherKey);
      localStorage.setItem('teacherKey', j.teacherKey); // 호환 저장
      localStorage.setItem('schoolId', s); localStorage.setItem('classId', k);
      $('msg').textContent='연결되었습니다.';
      drawState();
      return true;
    }else{
      $('msg').textContent = '실패: '+((j&&j.error)==='auth'?'비밀번호가 일치하지 않습니다.':'서버 응답 오류');
      return false;
    }
  }catch(e){
    $('msg').textContent='네트워크 오류 또는 타임아웃';
    return false;
  }
}

/* ================= 카메라 준비/점검 ================= */
const camStatusEl = $('camStatus');
const helpEl = $('camHelp');
const ua = navigator.userAgent.toLowerCase();
const isAndroid = ua.includes('android');
const isIOS = /iphone|ipad|ipod/.test(ua);

function platformHelpHTML(){
  if(isAndroid){
    return [
      '① 주소창의 <b>자물쇠 아이콘</b> 탭 → <b>사이트 설정</b> → <b>카메라</b> → <b>허용</b>',
      '② 처음 한 번은 아래 <b>카메라 권한 요청하기</b> 버튼을 눌러 팝업에서 <b>허용</b>',
      '③ 카카오/인스타 등 <b>인앱 브라우저는 권한이 막힐 수 있으니</b> Chrome/Samsung Internet으로 열기'
    ].map(x=>`<li>${x}</li>`).join('');
  }else if(isIOS){
    return [
      '① <b>설정 &gt; Safari &gt; 카메라 &gt; 허용</b>',
      '② 사파리에서 이 페이지를 열고 아래 <b>카메라 권한 요청하기</b> 버튼을 눌러 <b>허용</b>',
      '③ 사파리의 <b>개인 브라우징</b>은 저장정보가 지워질 수 있어 꺼두는 것을 권장'
    ].map(x=>`<li>${x}</li>`).join('');
  }
  return [
    '① 주소창의 <b>자물쇠 아이콘</b> → 사이트 설정에서 카메라를 <b>허용</b>',
    '② 아래 <b>카메라 권한 요청하기</b> 버튼으로 권한 팝업을 띄운 뒤 <b>허용</b>'
  ].map(x=>`<li>${x}</li>`).join('');
}

async function updateCamStatus(){
  camStatusEl.textContent = '상태 확인 중…';
  if(!('mediaDevices' in navigator)){ camStatusEl.textContent='이 브라우저는 카메라 API를 지원하지 않습니다.'; return; }
  // Permissions API가 없을 수 있으므로 try/catch
  try{
    if('permissions' in navigator && navigator.permissions.query){
      const st = await navigator.permissions.query({name:'camera'});
      if(st.state==='granted'){ camStatusEl.textContent='카메라 권한: 허용됨'; }
      else if(st.state==='denied'){ camStatusEl.textContent='카메라 권한: 차단됨 (아래 버튼 또는 안내에 따라 허용해 주세요)'; }
      else { camStatusEl.textContent='카메라 권한: 미확정 (아래 버튼으로 요청할 수 있어요)'; }
      // 상태가 바뀌면 자동 갱신
      st.onchange = () => updateCamStatus();
      return;
    }
  }catch(_){/* 무시 */}
  camStatusEl.textContent='카메라 권한 상태를 확인할 수 없습니다. 아래 버튼으로 권한을 요청해 주세요.';
}

$('btnOpenHelp').onclick = ()=>{
  helpEl.style.display = helpEl.style.display==='none' ? 'block' : 'none';
  helpEl.innerHTML = `<ul class="bullets" style="margin-top:6px">${platformHelpHTML()}</ul>`;
};

$('btnReqCam').onclick = async ()=>{
  if(!('mediaDevices' in navigator)){ alert('이 브라우저는 카메라를 지원하지 않습니다.'); return; }
  try{
    // 사용자 제스처로 권한 팝업을 띄우고, 스트림은 즉시 종료
    const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'user'}}, audio:false});
    s.getTracks().forEach(t=>t.stop());
    camStatusEl.textContent = '카메라 권한: 허용됨 (성공)';
  }catch(e){
    camStatusEl.textContent = '카메라 권한: 거부됨 또는 실패 (설정 안내 참고)';
    // iOS/Android에서 거부 시 OS/브라우저 설정으로 직접 이동시키는 것은 불가 — 안내로 대체
    if(helpEl.style.display==='none'){ $('btnOpenHelp').click(); }
  }
};

updateCamStatus();
</script>

<!-- PATCH: mobile-safe query, handlers, and link fix -->
<script>
(function(){
  const $ = (id)=> document.getElementById(id);
  function basePath(name){ return new URL(name, location.href).href; }

  // 1) '수업하기' 링크를 게시된 주소로 고정 + 새창 방지
  if ($('linkClass')) {
    $('linkClass').href = 'https://sites.google.com/view/mazerunning/%ED%99%88';
    $('linkClass').removeAttribute('target');
    $('linkClass').rel = 'noopener';
  }
  // 2) '카메라 권한 요청하기'는 현재 폴더의 capture_basic.html로
  if ($('openCaptureBasic')) {
    $('openCaptureBasic').setAttribute('href', basePath('capture_basic.html'));
  }

  // 3) 비밀번호 안내/검증(4자리 이상)
  if ($('tcode')) {
    $('tcode').setAttribute('placeholder', '예) 4자리 이상');
    $('tcode').setAttribute('minlength', '4');
  }

  // 4) JSONP (없으면 제공)
  if (typeof window.jsonp !== 'function') {
    window.jsonp = function(url){
      return new Promise((resolve)=>{
        const cb = 'cb' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        const u = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
        window[cb] = function(data){ try{ delete window[cb]; }catch(_){
        } document.body.removeChild(s); resolve(data); };
        s.src = u; s.onerror = ()=> resolve({ok:false,error:'net'});
        document.body.appendChild(s);
      });
    };
  }

  // 5) 파라미터 직렬화 (URLSearchParams 폴백)
  function qs(obj){
    const out=[]; for(const k in obj) if(Object.prototype.hasOwnProperty.call(obj,k)){ 
      const v = obj[k]==null ? '' : String(obj[k]);
      out.push(encodeURIComponent(k)+'='+encodeURIComponent(v));
    }
    return out.join('&');
  }
  function toQuery(obj){
    try{
      if (typeof URLSearchParams!=='undefined'){ 
        const u=new URLSearchParams(obj);
        const s=(typeof u.toString==='function')?u.toString():String(u);
        if (s && s.indexOf('=')>=0) return s;
      }
    }catch(_){}
    return qs(obj);
  }

  // 6) EXEC: 전역 EXEC > localStorage EXEC > 안전한 기본값
  const EXEC_URL = (typeof window.EXEC==='string' && window.EXEC.trim()) 
    ? window.EXEC.trim() 
    : ((localStorage.getItem('EXEC')||'').trim() || 'https://script.google.com/macros/s/AKfycbzNUWjOhh3V-Cu2WYkl6voDKoAHFKjOl_OQbKH6rQYj6o8K06YoQmc0D7Q6WMJJ-Foz/exec');

  // 7) 안전한 '나의 학급 들어가기' (바인드만)
  async function bindOnlySafe(){
    const s=($('school')?.value||'').trim();
    const k=($('klass')?.value||'').trim();
    const c=($('tcode')?.value||'').trim();
    if(!s||!k||!c){ $('msg') && ($('msg').textContent='기관명/학급명/비밀번호를 모두 입력하세요.'); return false; }
    $('msg') && ($('msg').textContent='서버 확인 중…');
    const q = toQuery({action:'key', schoolId:s, classId:k, code:c});
    const r = await jsonp(EXEC_URL+'?'+q);
    if(r && r.ok && r.teacherKey){
      try{ localStorage.setItem('tk', r.teacherKey); localStorage.setItem('teacherKey', r.teacherKey); localStorage.setItem('schoolId', s); localStorage.setItem('classId', k); }catch(_){
      }
      $('msg') && ($('msg').textContent='연결되었습니다.');
      return true;
    } else {
      const err=(r&&r.error)||'auth';
      $('msg') && ($('msg').textContent = (err==='no class') ? '해당 학급이 없습니다. 먼저 학급을 생성하세요.' : '비밀번호가 일치하지 않습니다.');
      return false;
    }
  }

  // 8) 안전한 '학급 생성' (같은 기관/학급이라도 비번 다르면 새 TK)
  async function createOnlySafe(){
    const s=($('school')?.value||'').trim();
    const k=($('klass')?.value||'').trim();
    const c=($('tcode')?.value||'').trim();
    if(!s||!k||!c){ $('msg') && ($('msg').textContent='기관명/학급명/비밀번호를 모두 입력하세요.'); return false; }
    if(c.length<4){ $('msg') && ($('msg').textContent='비밀번호는 4자리 이상 입력하세요.'); return false; }
    $('msg') && ($('msg').textContent='학급 생성 중…');
    const q = toQuery({action:'createClass', schoolId:s, classId:k, code:c});
    const r = await jsonp(EXEC_URL+'?'+q);
    if(r && r.ok && r.teacherKey){
      try{ localStorage.setItem('tk', r.teacherKey); localStorage.setItem('teacherKey', r.teacherKey); localStorage.setItem('schoolId', s); localStorage.setItem('classId', k); }catch(_){
      }
      $('msg') && ($('msg').textContent='학급이 생성되었습니다. "나의 학급 들어가기"를 누르세요.');
      return true;
    } else {
      const err=(r&&r.error)||'unknown';
      $('msg') && ($('msg').textContent = (err==='exists') 
        ? '이미 같은 비밀번호의 학급이 있습니다. "나의 학급 들어가기"를 사용하세요.' 
        : '생성 실패: '+err);
      return false;
    }
  }

  // 9) 버튼 핸들러 재지정 (UI 변경 없음, 동작만 교체)
  if ($('joinBtn')) $('joinBtn').onclick = createOnlySafe;
  if ($('goDashboardBtn')) $('goDashboardBtn').onclick = async ()=>{
    try{ localStorage.removeItem('tk'); localStorage.removeItem('teacherKey'); sessionStorage.removeItem('tk'); sessionStorage.removeItem('teacherKey'); }catch(_){
    }
    const ok = await bindOnlySafe();
    if(ok){
      const next = (typeof window.DASH==='function') ? window.DASH() : basePath('dashboard.html');
      location.href = next;
    }
  };
  if ($('unbindBtn')) $('unbindBtn').onclick = ()=>{
    if(!confirm('이 기기의 연결정보를 삭제하고 손님모드로 전환합니다. 진행할까요?')) return;
    ['tk','teacherKey','schoolId','classId','faceDB'].forEach(k=>{ try{ localStorage.removeItem(k); sessionStorage.removeItem(k); }catch(_){
    } });
    $('msg') && ($('msg').textContent='이 기기의 저장정보가 삭제되었습니다.');
  };
})();
</script>

</body>
</html>

