<!doctype html>
<html lang="ko">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>교사용 홈 · 불의 마법을 푸는 안전 열쇠</title>
<style>
:root{--bg-top:#cfe9fb;--bg-bottom:#fff;--ink:#0b2a4a;--pill:#0d2744;--card:#f6fbff;--line:#d7e7f5;--safe:#22c55e;--warn:#f59e0b}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;color:var(--ink);background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom))}
.wrap{max-width:1024px;margin:0 auto;padding:18px 14px 40px}
.banner{display:block;width:100%;max-width:980px;margin:8px auto 0}
.sub{margin:10px auto 16px;display:inline-block;padding:10px 18px;border-radius:999px;background:var(--pill);color:#fff;font-weight:800}
.grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}
@media (max-width:920px){.grid{grid-template-columns:1fr}}
.box{background:var(--card);border:1px solid var(--line);border-radius:20px;padding:16px 16px 18px;box-shadow:0 8px 30px rgba(13,39,68,.06)}
h3{margin:2px 0 10px;font-size:20px}
label{display:block;font-size:14px;margin:10px 0 6px;font-weight:700}
input,button{width:100%;box-sizing:border-box;border-radius:14px;border:1px solid var(--line);padding:12px 14px;font-size:16px;background:#fff;outline:none}
button{background:#274766;color:#fff;font-weight:800;border:none;cursor:pointer;box-shadow:0 6px 14px rgba(15,47,87,.18)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.note{font-size:12px;opacity:.8}
.btn-safe{width:100%;background:var(--safe);color:#093b18;font-weight:900;border:none;padding:16px 18px;border-radius:16px;font-size:18px;box-shadow:0 8px 18px rgba(34,197,94,.3)}
.btn-safe:hover{filter:brightness(1.05)}
/* 눈에 띄는 ‘이 기기 연결 해제’ 버튼 */
.btn-unbind{
  width:100%; margin-top:10px; padding:12px 14px; border:0; border-radius:14px; font-weight:900;
  background:var(--warn); color:#3b1f00; box-shadow:0 8px 18px rgba(245,158,11,.35);
}
</style>
<body>
  <div class="wrap">
    <img class="banner" src="https://seol-glitter.github.io/teacherhome/banner.png" alt="불의 마법을 푸는 안전 열쇠 배너">
    <div class="sub">교사용 홈화면</div>

    <div class="grid">
      <!-- 좌측: 기관/반 설정 -->
      <section class="box">
        <h3>기관/반 설정</h3>
        <label>기관명</label>
        <input id="schoolId" placeholder="예: 대한유치원">
        <label>반 이름</label>
        <input id="classId" placeholder="예: 무지개반">
        <label>교사용 비밀번호</label>
        <input id="tcode" type="password" placeholder="예: RAINBOW-2025">
        <div class="row" style="margin-top:12px">
          <button id="goDash">나의 학급 들어가기</button>
          <button id="makeSession" style="background:#1f3b68">학급 생성</button>
        </div>

        <!-- 눈에 잘 띄는 연결 해제 -->
        <button id="unbind" class="btn-unbind">이 기기 연결 해제</button>

        <div id="msg" class="note" style="margin-top:6px"></div>
      </section>

      <!-- 우측: 수업하기 + 안내 -->
      <section class="box">
        <h3>수업하기</h3>
        <button id="goClassSite" class="btn-safe">수업하기 (가입 없이 바로 사용)</button>
        <div style="height:10px"></div>
        <h3>안내</h3>
        <div class="note" style="line-height:1.6">
          • <b>‘수업하기’</b>는 <b>가입 없이</b> 대집단 수업에 바로 활용할 수 있습니다.<br>
          • <b>‘학급 생성’</b>으로 <b>학급 유아의 성취 상황</b>을 기록할 수 있습니다.<br>
          • <b>‘나의 학급 들어가기’</b>에서 <b>학급 유아의 성취 상황</b>을 확인할 수 있습니다.<br>
          • 같은 <b>기관명·반 이름</b>이라도 <b>비밀번호가 다르면</b> 서로 독립된 학급으로 인식됩니다.<br>
          • <b>수집된 자료는 가입일로부터 18개월 후 자동삭제</b>됩니다.
        </div>
      </section>
    </div>
  </div>

<script>
// === 기기 초기화 (?reset=1) ===
const _q=new URLSearchParams(location.search);
if(_q.get('reset')==='1'){
  ['tk','mode','schoolId','classId','faceDB'].forEach(k=>localStorage.removeItem(k));
  location.href = location.origin + location.pathname;
}
// EXEC / 대시보드 / 수업하기
const EXEC_B="https://script.google.com/macros/s/AKfycbzNUWjOhh3V-Cu2WYkl6voDKoAHFKjOl_OQbKH6rQYj6o8K06YoQmc0D7Q6WMJJ-Foz/exec";
const DASH="https://seol-glitter.github.io/teachersboard/";
const SITES_URL="https://sites.google.com/view/mazerunning/%ED%99%88";

function jsonp(url,timeoutMs=10000){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2)+Date.now().toString(36);
    window[cb]=(d)=>{cleanup();resolve(d)};
    function cleanup(){try{delete window[cb]}catch(_){ } if(s&&s.parentNode)s.parentNode.removeChild(s); if(t)clearTimeout(t);}
    const s=document.createElement('script'); s.src=url+(url.includes('?')?'&':'?')+'callback='+cb+'&_v='+Date.now();
    s.onerror=()=>{cleanup();reject(new Error('JSONP failed'))};
    document.body.appendChild(s); const t=setTimeout(()=>{cleanup();reject(new Error('Timeout'))},timeoutMs);
  });
}
const $=id=>document.getElementById(id);
$('goClassSite').onclick=()=>window.open(SITES_URL,'_blank');
$('unbind').onclick=()=>{['tk','mode','schoolId','classId','faceDB'].forEach(k=>localStorage.removeItem(k)); alert('이 기기의 학급 연결을 해제했어요. 다음 접속부터 손님모드로 작동합니다.');};

window.addEventListener('DOMContentLoaded',()=>{
  const s=localStorage.getItem('schoolId'); const c=localStorage.getItem('classId');
  if(s)$('schoolId').value=s; if(c)$('classId').value=c;
});

async function gotoDashboard(createSession){
  const school=$('schoolId').value.trim(), klass=$('classId').value.trim(), code=$('tcode').value.trim();
  if(!school||!klass||!code){$('msg').textContent='기관/반/비밀번호를 입력하세요.'; return;}
  $('msg').textContent='확인 중…';
  try{
    const j=await jsonp(`${EXEC_B}?`+new URLSearchParams({action:'key',schoolId:school,classId:klass,code:code}).toString());
    if(!j.ok||!j.teacherKey){$('msg').textContent='로그인 실패';return;}
    localStorage.setItem('tk', j.teacherKey);
    localStorage.setItem('mode','b');
    localStorage.setItem('schoolId',school);
    localStorage.setItem('classId',klass);

    if(createSession){
      await jsonp(`${EXEC_B}?`+new URLSearchParams({action:'createSession',schoolId:school,classId:klass,code:code,child:klass}).toString());
    }
    $('msg').textContent='대시보드로 이동합니다…';
    location.href = `${DASH}?v=${Date.now().toString(36)}`; // tk/mode는 로컬스토리지에서 자동 사용
  }catch(e){ $('msg').textContent='네트워크 오류: '+e.message; }
}
$('goDash').onclick = ()=>gotoDashboard(false);
$('makeSession').onclick = ()=>gotoDashboard(true);
</script>
</body>
</html>
