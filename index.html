<!doctype html>
<html lang="ko">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>교사용 홈 · 불의 마법을 푸는 안전 열쇠</title>
<style>
:root{
  --bg-top:#cfe9fb; --bg-bottom:#fff; --ink:#0b2a4a;
  --accent:#0f2f57; --pill:#0d2744; --card:#f6fbff; --line:#d7e7f5;
  --safe:#22c55e;
}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;color:var(--ink);
  background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom))}
.wrap{max-width:1024px;margin:0 auto;padding:18px 14px 40px}
.banner{display:block;width:100%;max-width:980px;margin:8px auto 0}
.sub{margin:10px auto 16px;display:inline-block;padding:10px 18px;border-radius:999px;background:var(--pill);color:#fff;font-weight:800}
.grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}
@media (max-width:920px){.grid{grid-template-columns:1fr}}
.box{background:var(--card);border:1px solid var(--line);border-radius:20px;padding:16px 16px 18px;box-shadow:0 8px 30px rgba(13,39,68,.06)}
h3{margin:2px 0 10px;font-size:20px}
label{display:block;font-size:14px;margin:10px 0 6px;font-weight:700}
input,button{width:100%;box-sizing:border-box;border-radius:14px;border:1px solid var(--line);padding:12px 14px;font-size:16px;background:#fff;outline:none}
button{background:var(--accent);color:#fff;font-weight:800;border:none;cursor:pointer;box-shadow:0 6px 14px rgba(15,47,87,.18)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.note{font-size:12px;opacity:.85}
.btn-safe{width:100%;background:var(--safe);color:#093b18;font-weight:900;border:none;
  padding:16px 18px;border-radius:16px;font-size:18px;box-shadow:0 8px 18px rgba(34,197,94,.3)}
.btn-safe:hover{filter:brightness(1.05)}
</style>
<body>
  <div class="wrap">
    <img class="banner" src="https://seol-glitter.github.io/teacherhome/banner.png" alt="불의 마법을 푸는 안전 열쇠 배너">
    <div class="sub">교사용 홈화면</div>

    <div class="grid">
      <section class="box">
        <h3>기관/반 설정</h3>
        <label>기관명</label>
        <input id="schoolId" placeholder="예: 대한유치원">
        <label>반 이름</label>
        <input id="classId" placeholder="예: 무지개반">
        <label>교사용 비밀번호</label>
        <input id="tcode" type="password" placeholder="예: RAINBOW-2025">
        <div class="row" style="margin-top:12px">
          <button id="goDash">나의 학급 들어가기</button>
          <button id="makeSession" style="background:#274766">학급 생성</button>
        </div>
        <div id="msg" class="note" style="margin-top:6px"></div>
      </section>

      <section class="box">
        <h3>수업하기</h3>
        <button id="goClassSite" class="btn-safe">수업하기 (가입 없이 바로 사용)</button>
        <div style="height:10px"></div>
        <h3>안내</h3>
        <div class="note" style="line-height:1.6">
          • <b>‘수업하기’</b>: 가입 없이 대집단 수업 자료 바로 사용<br>
          • <b>‘학급 생성’</b>: 학급 유아의 성취를 기록/관리 시작<br>
          • <b>‘나의 학급 들어가기’</b>: 성취 현황 대시보드 확인<br>
          • 같은 <b>기관명·반 이름</b>이라도 <b>비밀번호가 다르면 데이터 분리</b><br>
          • <b>수집된 자료는 가입일로부터 18개월 후 자동삭제</b>
        </div>
      </section>
    </div>
  </div>

<script>
// ❗ 배포 전 2줄만 바꾸세요
const EXEC_B = "https://script.google.com/macros/s/AKfycbzNUWjOhh3V-Cu2WYkl6voDKoAHFKjOl_OQbKH6rQYj6o8K06YoQmc0D7Q6WMJJ-Foz/exec"; // B모드 웹앱 /exec
const EXEC_A = "https://script.google.com/macros/s/AKfycby4camh7UDnlV4ElL3eJPUUWvslSAtfyssAQBRfizcY9D1MRJK9r_O0ZYDnQvKryalG/exec"; // A모드 웹앱 /exec (선택기관 전용)

// 모드 전파: ?mode=a 이면 A모드, 아니면 B모드
const MODE = (new URLSearchParams(location.search).get('mode')||'').toLowerCase()==='a' ? 'a' : 'b';
const EXEC = MODE==='a' ? EXEC_A : EXEC_B;

const DASH = "https://seol-glitter.github.io/teachersboard/"; // 대시보드 URL
const SITES_URL="https://sites.google.com/view/mazerunning/%ED%99%88";

function jsonp(url,timeoutMs=12000){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2)+Date.now().toString(36);
    window[cb]=(d)=>{cleanup();resolve(d)};
    function cleanup(){try{delete window[cb]}catch(_){}
      if(s&&s.parentNode)s.parentNode.removeChild(s); if(t)clearTimeout(t);}
    const s=document.createElement('script');
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb+'&_v='+(Date.now());
    s.onerror=()=>{cleanup();reject(new Error('JSONP failed'))};
    document.body.appendChild(s);
    const t=setTimeout(()=>{cleanup();reject(new Error('Timeout'))},timeoutMs);
  });
}
const $=id=>document.getElementById(id);
$('goClassSite').onclick=()=>window.open(SITES_URL,'_blank');

async function gotoDashboard(withSession){
  const school=$('schoolId').value.trim(), klass=$('classId').value.trim(), code=$('tcode').value.trim();
  if(!school||!klass||!code){$('msg').textContent='기관/반/비밀번호를 입력하세요.';return;}
  $('msg').textContent='확인 중…';
  try{
    const r=await jsonp(`${EXEC}?action=key&schoolId=${encodeURIComponent(school)}&classId=${encodeURIComponent(klass)}&code=${encodeURIComponent(code)}`);
    if(!r.ok||!r.teacherKey){$('msg').textContent='로그인 실패';return;}
    if(withSession){
      await jsonp(`${EXEC}?action=createSession&schoolId=${encodeURIComponent(school)}&classId=${encodeURIComponent(klass)}&code=${encodeURIComponent(code)}`);
    }
    localStorage.setItem('schoolId',school); localStorage.setItem('classId',klass);
    $('msg').textContent='대시보드로 이동합니다…';
    location.href = `${DASH}?tk=${encodeURIComponent(r.teacherKey)}&mode=${MODE}`;
  }catch(e){ $('msg').textContent='네트워크 오류: '+e.message; }
}
$('goDash').onclick = ()=>gotoDashboard(false);
$('makeSession').onclick = ()=>gotoDashboard(true);

window.addEventListener('DOMContentLoaded',()=>{
  const s=localStorage.getItem('schoolId'); const c=localStorage.getItem('classId');
  if(s) $('schoolId').value=s; if(c) $('classId').value=c;
});
</script>
</body>
</html>
