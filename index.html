<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>교사 홈(기관/반/교사용 비밀번호)</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif; padding:16px; line-height:1.5}
  input, textarea{padding:10px; border:1px solid #ddd; border-radius:10px; width:100%; max-width:560px}
  textarea{min-height:140px}
  button{padding:10px 16px; border:0; border-radius:10px; font-weight:700; background:#111; color:#fff; margin-top:8px; cursor:pointer}
  .box{border:1px solid #eee; border-radius:12px; padding:12px; margin-bottom:16px; background:#fafafa}
  .row{margin:6px 0}
  .note{font-size:12px; opacity:.75}
  .links a{display:block; margin:8px 0; padding:10px; background:#f4f4f4; border-radius:10px; text-decoration:none; color:#111}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; word-break:break-all}
</style>

<body>
  <h2>교사 홈</h2>

  <!-- A. 공통 기본값 -->
  <div class="box">
    <div class="row">기관명</div>
    <input id="schoolId" placeholder="예: 세천유치원">
    <div class="row" style="margin-top:6px">반 이름</div>
    <input id="classId"  placeholder="예: 무지개반">
    <div class="row" style="margin-top:6px">교사용 비밀번호 <span class="note">(교사 개인만 아는 비밀번호)</span></div>
    <input id="tcode" type="password" placeholder="예: RAINBOW-2025">
  </div>

  <!-- B. 학급 유아 명단 등록/수정 (폼 POST: 긴 데이터 OK) -->
  <div class="box">
    <h3>학급 유아 명단 등록/수정</h3>
    <div class="note">한 줄에 한 명(엔터로 구분) 또는 쉼표로 구분 가능합니다.</div>

    <form id="rosterForm" method="post" target="hidden_iframe"
          action="https://script.google.com/macros/s/AKfycbwxQdrD9d358f1OWhIzC54f4pnCArgmNqx4LQqBpsYDlUnRAJU_A5hqdVZnnO5tIhHcOA/exec"
          onsubmit="return submitRoster()">
      <input type="hidden" name="action"   value="saveRoster">
      <input type="hidden" name="schoolId" id="f_school">
      <input type="hidden" name="classId"  id="f_class">
      <input type="hidden" name="code"     id="f_code">

      <textarea name="roster" id="f_roster" placeholder="예)
민준
서윤
지호
하린"></textarea>
      <div><button type="submit">명단 저장</button> <span id="saveMsg" class="note"></span></div>
    </form>
    <iframe name="hidden_iframe" style="display:none"></iframe>
  </div>

  <!-- C. 세션 만들기(JSONP GET → 짧은 쿼리) -->
  <div class="box">
    <h3>세션 만들기</h3>
    <div class="note">유아가 이름을 선택하지 않을 때 표시할 기본 닉네임(선택)</div>
    <input id="defaultChild" placeholder="예: 꽃잎1 / 무지개-07 (선택)">
    <div style="margin-top:8px">
      <button id="create">세션 만들기</button>
      <button id="ping" style="background:#444;margin-left:8px">서버 점검(테스트)</button>
      <span id="msg" class="note"></span>
    </div>
    <div id="raw" class="note mono" style="margin-top:8px"></div>
  </div>

  <!-- D. 문제 링크 -->
  <div class="box">
    <h3>문제 링크</h3>
    <div id="links" class="links"><div class="note">세션을 먼저 만들면 여기에 버튼이 나타납니다.</div></div>
  </div>

<script>
// 문제 목록
const PROBLEMS = [
  { id:"02_위험찾기",         title:"2) 위험 찾기" },
  { id:"03_화재대피안전수칙", title:"3) 화재 대피 안전수칙" },
  { id:"04_비상구로대피",     title:"4) 비상구로 대피하기" },
  { id:"05_옷에불이붙었어요", title:"5) 옷에 불이 붙었어요" },
  { id:"06_119신고하기",      title:"6) 119 신고하기" },
  { id:"07_소화기사용법",     title:"7) 소화기 사용법" },
  { id:"08_완강기사용법",     title:"8) 완강기 사용법" }
];

// ★ Apps Script /exec
const SESSION_API = "https://script.google.com/macros/s/AKfycbwxQdrD9d358f1OWhIzC54f4pnCArgmNqx4LQqBpsYDlUnRAJU_A5hqdVZnnO5tIhHcOA/exec";

// JSONP 유틸(+타임아웃)
function jsonp(url, timeoutMs=10000){
  return new Promise((resolve, reject)=>{
    const cb = 'cb_' + Date.now().toString(36) + Math.random().toString(36).slice(2);
    let done=false, timer=null;
    window[cb] = (data)=>{ if(done) return; done=true; cleanup(); resolve(data); };
    function cleanup(){ try{ delete window[cb]; }catch(e){} if(s&&s.parentNode)s.parentNode.removeChild(s); if(timer)clearTimeout(timer); }
    const s = document.createElement('script');
    s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
    s.onerror = ()=>{ if(done) return; done=true; cleanup(); reject(new Error('JSONP failed')); };
    document.body.appendChild(s);
    timer = setTimeout(()=>{ if(done) return; done=true; cleanup(); reject(new Error('Timeout')); }, timeoutMs);
  });
}

let submitted = false;
// 명단 저장(폼 POST)
function submitRoster(){
  const school = document.getElementById('schoolId').value.trim();
  const klass  = document.getElementById('classId').value.trim();
  const code   = document.getElementById('tcode').value.trim();
  if(!school || !klass || !code){ alert('기관명/반/교사용 비밀번호를 입력하세요.'); return false; }
  document.getElementById('f_school').value = school;
  document.getElementById('f_class').value  = klass;
  document.getElementById('f_code').value   = code;
  submitted = true;
  document.getElementById('saveMsg').textContent = '저장 중…';
  return true;
}
document.querySelector('iframe[name="hidden_iframe"]').addEventListener('load', ()=>{
  if (submitted){ document.getElementById('saveMsg').textContent = '저장 완료'; submitted = false; }
});

// 세션 만들기(JSONP)
document.getElementById('create').onclick = async ()=>{
  const school = document.getElementById('schoolId').value.trim();
  const klass  = document.getElementById('classId').value.trim();
  const code   = document.getElementById('tcode').value.trim();
  const child  = document.getElementById('defaultChild').value.trim();
  if(!school || !klass || !code){ alert('기관명/반/교사용 비밀번호를 입력하세요.'); return; }

  try{
    const qs = new URLSearchParams({ action:'createSession', schoolId:school, classId:klass, code:code, child:child }).toString();
    const j  = await jsonp(`${SESSION_API}?${qs}`);
    if(!j.sid){ alert('세션 생성 실패:\n'+JSON.stringify(j)); return; }
    document.getElementById('msg').textContent = `세션 OK (~ ${j.expiresAt})`;
    document.getElementById('raw').textContent = '';

    const links = document.getElementById('links'); links.innerHTML = '';
    PROBLEMS.forEach(p=>{
      const a = document.createElement('a');
      a.textContent = p.title;
      a.href = `https://seol-glitter.github.io/teachercapture/?sid=${encodeURIComponent(j.sid)}&problem=${encodeURIComponent(p.id)}`;
      a.target = '_blank';
      links.appendChild(a);
    });
  }catch(e){
    alert('네트워크 오류(JSONP): ' + e.message);
  }
};

// 서버 점검(현재 입력값으로 미리 호출해 보기)
document.getElementById('ping').onclick = async ()=>{
  const school = document.getElementById('schoolId').value.trim();
  const klass  = document.getElementById('classId').value.trim();
  const code   = document.getElementById('tcode').value.trim();
  const child  = document.getElementById('defaultChild').value.trim();
  if(!school || !klass || !code){ alert('기관명/반/교사용 비밀번호를 입력하세요.'); return; }
  const url = `${SESSION_API}?` + new URLSearchParams({ action:'createSession', schoolId:school, classId:klass, code:code, child:child }).toString();
  document.getElementById('raw').textContent = '요청: ' + url;
  try{
    const j = await jsonp(url);
    document.getElementById('raw').textContent = '응답(JSONP): ' + JSON.stringify(j);
  }catch(e){
    document.getElementById('raw').textContent = '오류: ' + e.message + '\n(위 요청 URL을 브라우저 주소창에 직접 붙여 넣어 열어보세요.)';
  }
};
</script>
</body>
